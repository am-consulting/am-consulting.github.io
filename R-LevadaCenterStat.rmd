```{r warning=F,error=F,message=F,echo=F,results='hide'}
windowsFonts(Meiryo = windowsFont("Meiryo"))
pngWidth <- 1000
pngHeight <- 600
userName <- Sys.info()['user']
fileName <- 'defaultPath.csv'
pathToFile <-
  paste0('C:/Users/',userName,'/Desktop/pathToCSV/')
setwd(pathToFile)
buf0 <-
  read.csv(fileName,header = F,skip = 0,stringsAsFactor = F,check.names = F,
           fileEncoding = 'UTF8')
pathOutputLEVADA <- paste0('C:/Users/',userName,buf0[2,1],
                             'charts/indicator/AMCC-LEVADA/')
```

```{r}
script <-
  RCurl::getURL(
    url = "https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/importLEVADA.r",
    ssl.verifypeer = FALSE)
eval(parse(text = script))
for(iii in seq(length(levada))){
  print(tail(levada[[iii]],2))
}
```

```{r}
library(ggplot2)
vlineDate <- c(as.Date('1993-1-20'),as.Date('2001-1-20'),as.Date('2009-1-20'),as.Date('2017-1-20'))
vlineTxt <- c('Bill Clinton','George W. Bush','Barack Obama','Donald Trump')
annRect <- data.frame(S=vlineDate,E=c(tail(vlineDate,-1),Sys.Date()),P=vlineTxt,C=c('blue','red','blue','red'))
```

```{r}
fun_plot <- function(iii,output = 0){
if(output!=0){
  setwd(pathOutputLEVADA)
  pngFile <- paste0('AMCC-LEVADA-',iii,".png")
  png(file = pngFile,width = pngWidth,height = pngHeight)
}
obj <- na.omit(levada[[iii]])
annObj <- head(obj$Date,1)<=vlineDate
dateRange <- paste0(format(range(obj[,1]),'%Y-%m'),collapse = '~')
g <- ggplot(data = obj,aes(x = obj$Date))
g <- g + geom_line(aes(y = obj[,2],colour = colnames(obj)[2]))
g <- g + geom_point(aes(y = obj[,2],colour = colnames(obj)[2]),size = 2)
if(iii<=7){
  g <- g + geom_line(aes(y = obj[,3],colour = colnames(obj)[3]))
  g <- g + geom_point(aes(y = obj[,3],colour = colnames(obj)[3]),size = 2)
}
if(iii == 5){
  g <- g + geom_line(aes(y = obj[,4],colour = colnames(obj)[4]))
  g <- g + geom_point(aes(y = obj[,4],colour = colnames(obj)[4]),size = 2)
}
g <- g + scale_colour_manual(name = '',values = cols)
g <- g + annotate("rect",xmin=annRect[annObj,]$S,xmax=annRect[annObj,]$E,
                  ymin=-Inf,ymax=Inf,alpha=0.2,fill=annRect[annObj,]$C)
g <- g + ggtitle(label = paste0(titleList[iii],'\n',dateRange,'\nSource:Levada-Center'))
g <- g + xlab(label = '')
g <- g + scale_y_continuous(name = '',breaks = scales::pretty_breaks(10),sec.axis = dup_axis())
g <- g + theme(plot.title = element_text(hjust = 0.5,family = "Meiryo",size = 15))
g <- g + theme(plot.subtitle = element_text(hjust = 0.5,family = "Meiryo",size = 12))
g <- g + theme(axis.title.x = element_text(family = "Meiryo",size = 16)) 
g <- g + theme(axis.title.y = element_text(family = "Meiryo",size = 16)) 
g <- g + theme(axis.text.x = element_text(angle = 0,family = "Meiryo",size = 12,vjust = 0.5)) 
g <- g + theme(axis.text.y = element_text(angle = 0,family = "Meiryo",size = 16))
g <- g + theme(legend.text = element_text(angle = 0,family = "Meiryo",size = 16))
g <- g + theme(legend.position = "top")
g <- g + annotate("text",x = vlineDate[annObj],y = -Inf,label= vlineTxt[annObj],
                  angle = 90,vjust = 1,hjust = 0,size = 6,col = 'black',family = 'Meiryo')
print(g)
if(output!=0){dev.off()}
}
```

```{r}
cols <- c('Approve'='blue','Disapprove'='red')
fun_plot(iii = 1,output = 1)
fun_plot(iii = 2,output = 1)
fun_plot(iii = 3,output = 1)
cols <- c('In the right direction'='blue','On the wrong track'='red')
fun_plot(iii = 4,output = 1)
cols <- c('Safe'='blue','Tense'='orange','Dangerous'='red')
fun_plot(iii = 5,output = 1)
cols <- c('Positive'='blue','Negative'='red')
fun_plot(iii = 6,output = 1)
fun_plot(iii = 7,output = 1)
cols <- c('Social Sentiment Index'='blue')
fun_plot(iii = 8,output = 1)
cols <- c('Consumer Sentimet Index'='blue')
fun_plot(iii = 9,output = 1)
cols <- c('Unemployment Index'='blue')
fun_plot(iii = 10,output = 1)
```

```{r}
txt <- ''
for(iii in seq(length(levada))){
  txt <- paste0(txt,'<b>',titleList[iii],'</b><br>\n')
  txt <- 
    paste0(txt,
           '<a href="http://indicator.am-consulting.co.jp/AMCC-LEVADA/AMCC-LEVADA-',iii,'.png">\n')
  txt <- 
    paste0(txt,
           '<img border="2" src="http://indicator.am-consulting.co.jp/AMCC-LEVADA/AMCC-LEVADA-',iii,
           '.png" width="40%" />\n')
  txt <-
    paste0(txt,'Timeseries\n</a>\n<hr>\n')
}
setwd(pathOutputLEVADA)
write.table(x = txt,file = 'AMCC-LEVADA.html',append = F,
            fileEncoding = 'utf8',col.names = F,row.names = F,quote = F)
```
