```{r warning=F,error=F,message=F,echo=F,results='hide'}
library(ggplot2);library(scales)
windowsFonts(Meiryo = windowsFont("Meiryo"))
options(scipen = 100)
pngWidth <- 1000
pngHeight <- 1000
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
userName <- Sys.info()['user']
fileName <- 'defaultPath.csv'
pathToFile <-
  paste0('C:/Users/',userName,'/Desktop/pathToCSV/')
setwd(pathToFile)
buf0 <-
  read.csv(fileName,header = F,skip = 0,stringsAsFactor = F,check.names = F,
           fileEncoding = 'UTF8')
pathOutputCorporateStatistics <-
  paste0('C:/Users/',userName,buf0[2,1],'charts/indicator/AMCC-CorporateStatistics/')
```

```{r}
# https://www.e-stat.go.jp/SG1/toukeidb/GH07010101Forward.do
# [時系列データ]金融業、保険業以外の業種(原数値)
library(Nippon)
csvFile <- 'FEH_00350600_170804121934.csv'
baseURL <- 'https://github.com/am-consulting/am-consulting.github.io/raw/master/csv/csvData/TSdata/'
pathToDownloadFolder <-
  paste0("C:/Users/",Sys.info()['user'],"/Desktop/R_Data_Write/")
setwd(pathToDownloadFolder)
download.file(paste0(baseURL,csvFile),csvFile,mode = 'wb')
buf0 <- read.csv(file = csvFile,header = F,
                 stringsAsFactors = F,na.strings = '',fileEncoding = 'UTF8')
objRaw <- c(grep('統計名',buf0[,1]),nrow(buf0))
houjinToukei <- list()
for(iii in seq(length(objRaw)-1)){
  tmp0 <- buf0[objRaw[iii]:(objRaw[iii+1]-1),]
  bufTitle <- zen2han(paste0(tmp0[5,3],':',tmp0[6,3]))
  tmp1 <- tmp0[!is.na(as.numeric(tmp0[,1])),]
  colnames(tmp1) <- sapply(tmp0[9,],zen2han)
  tmp1 <- apply(tmp1,2,as.numeric)
  objCol <- grep('百万円',colnames(tmp1))
  tmp1[,objCol] <- apply(tmp1[,objCol],2,function(x)as.numeric(x)*10^-2)
  colnames(tmp1)[objCol] <- gsub('百万円','億円',colnames(tmp1)[objCol])
  Date <-
    as.Date(paste0(substring(tmp1[,1],1,4),'-',as.numeric(substring(tmp1[,1],5,5))*3,'-1'))
  tmp2 <- tmp1[,-grep('na',colnames(tmp1),ignore.case = T)]
  tmp3 <- data.frame(Date,tmp2,stringsAsFactors = F,check.names = F,row.names = NULL)
  colnames(tmp3)[1] <- paste0(bufTitle,':',colnames(tmp3)[1]) 
  houjinToukei[[iii]] <- tmp3
  print(tail(houjinToukei[[iii]][,1:3]))
}
colnames(houjinToukei[[iii]])
```

```{r}
fun_dataShape <- function(keyWord = '売上高経常利益率'){
  objCol <- grep(keyWord,colnames(houjinToukei[[1]]))
  item <- vector()  
  for(iii in seq(length(houjinToukei))){
    obj <- na.omit(houjinToukei[[iii]][,c(1,objCol)])
    bufTitle <- colnames(obj)[2]
    dateRange <- paste0(format(range(obj[,1]),'%Y年%m月期'),collapse = '~')
    colnames(obj)[2] <- gsub(':date','',colnames(obj)[1],ignore.case = T)
    colnames(obj)[1] <- paste0('Date:',bufTitle)
    if(iii==1){allData <-obj}else{allData <- merge(allData,obj,by=colnames(obj)[1],all=T)}
  }
  buf0 <- na.omit(t(tail(allData,1)))
  buf1 <- data.frame(rownames(buf0),buf0,stringsAsFactors = F,check.names = F,row.names = NULL)
  colnames(buf1) <- buf1[1,]
  buf2 <- buf1[-1,]
  buf2[,2] <- as.numeric(buf2[,2])
  colnames(buf2) <- 
    c('Industry',paste0(gsub('date:','',colnames(buf2)[1],ignore.case = T),
                        ':',format(as.Date(colnames(buf2)[2]),'%Y年%m月期')))
  buf3 <- buf2[order(buf2[,2]),]
  row.names(buf3) <- NULL
  buf3[,1] <-factor(buf3[,1],levels = buf3[,1])
  buf3$colour <- ifelse(0 <= buf3[,2],'positive','negative')
  latestData <- buf3
  returnList <-
      list('allData' = allData,
           'latestData' = latestData)
  return(returnList)
}
```

```{r}
fun_ggplotTimeSeries <- function(obj,output = 0,pngN = 1){
  if(output!=0){
    setwd(pathOutputCorporateStatistics)
    pngFile <- paste0('AMCC-CorporateStatistics-TS-',pngN,".png")
    png(file = pngFile,width = pngWidth,height = pngHeight)
  }
  g <- ggplot(data = obj,aes(x = obj[,1],y = obj[,2]))
  g <- g + geom_line(col='blue') + geom_point(col='blue') + geom_smooth(col='red') + xlab('')
  g <- g + scale_y_continuous(name = '',breaks = scales::pretty_breaks(10),sec.axis = dup_axis())
  g <- g + ggtitle(label = paste0(gsub('date:','',colnames(obj)[1],ignore.case = T),
                                  '\n',colnames(obj)[2],'\n',dateRange,'\nSource:財務省'))
  g <- g + theme(plot.title = element_text(hjust = 0.5,family = "Meiryo",size = 20))
  g <- g + theme(axis.title.x = element_text(family = "Meiryo",size = 16))
  g <- g + theme(axis.title.y = element_text(family = "Meiryo",size = 16))
  g <- g + theme(axis.text.x = element_text(angle = 0,family = "Meiryo",size = 16,vjust = 0.5))
  g <- g + theme(axis.text.y = element_text(angle = 0,family = "Meiryo",size = 16))
  print(g)
  if(output!=0){dev.off()}
}  
```

```{r}
fun_ggplotLatestData <- function(latestData,pngN = 1,output = 0){
  if(output!=0){
    setwd(pathOutputCorporateStatistics)
    pngFile <- paste0('AMCC-CorporateStatistics-Latest-',pngN,".png")
    png(file = pngFile,width = pngWidth,height = pngHeight)
  }
  g <- ggplot(data = latestData,aes(x = latestData[,1],y = latestData[,2]))
  g <- g + geom_bar(stat = 'identity',alpha = 0.5,aes(fill = colour))
  g <- g + scale_fill_manual(values = c(positive = 'steelblue',negative = 'firebrick1'))
  g <- g + theme(legend.position = 'none') + coord_flip() + xlab('') + ylab('')
  g <- g + ggtitle(paste0(colnames(latestData)[2],'\nSource:財務省'))
  g <- g + theme(plot.title = element_text(hjust = 0.5,family = "Meiryo",size = 20))
  g <- g + theme(axis.title.x = element_text(family = "Meiryo",size = 16))
  g <- g + theme(axis.title.y = element_text(family = "Meiryo",size = 16))
  g <- g + theme(axis.text.x = element_text(angle = 0,family = "Meiryo",size = 16,vjust = 0.5))
  g <- g + theme(axis.text.y = element_text(angle = 0,family = "Meiryo",size = 16))
  print(g)
  if(output!=0){dev.off()}
}
```

```{r}
baseURL <- 'http://indicator.am-consulting.co.jp/AMCC-CorporateStatistics/'
fun_outputHtml <- function(txt,iii,baseURL){
  txt <-
    paste0(txt,'<tr><td>',colnames(returnList$latestData)[2],'</td>')
  txt <- 
    paste0(txt,'<td><a href="',baseURL,'AMCC-CorporateStatistics-Latest-',iii,'.png">')
  txt <- 
    paste0(txt,'<img border="2" src="',baseURL,'AMCC-CorporateStatistics-Latest-',
           iii,'.png" width="50%" /></a></td></tr>')
  return(txt)
}
```

```{r}
txt <- ''
objCol <- grep('【%】|【月】|【回】',colnames(houjinToukei[[1]]))
for(iii in seq(length(objCol))){
  keyWord <- gsub('([^\\(]+)\\(.+','\\1',colnames(houjinToukei[[1]])[objCol[iii]])
  returnList <- fun_dataShape(keyWord = keyWord)
  obj <- returnList$allData
  fun_ggplotLatestData(latestData = returnList$latestData,pngN = iii,output = 1)
  txt <- fun_outputHtml(txt = txt,iii = iii,baseURL = baseURL)
}
txt <- paste0('<table class="amcc"><tr><td>項目</td><td>チャート</td></tr>',txt,'</table>')
setwd(pathOutputCorporateStatistics)
write.table(x = txt,file = 'AMCC-TS-CorporateStatistics.html',append = F,
            fileEncoding = 'utf8',col.names = F,row.names = F,quote = F)
```
