---
knit: (function(inputFile, encoding) {username<-Sys.info()['user'];fileName<-'defaultPath.csv';pathToFile <-paste0('C:/Users/', username,'/Desktop/pathToCSV/');setwd(pathToFile);buf0<-read.csv(fileName,header = F,skip = 0,stringsAsFactor = F,check.names = F,fileEncoding = 'utf-8');timeStamp<-format(Sys.time(),'%Y-%m-%d %H:%M:%S');htmlName<-'00028';tmp<-read.csv(file = paste0('C:/Users/',username,buf0[2,1],'csv/timeSeriesList.csv'),fileEncoding = 'UTF8',stringsAsFactors = F);Bigtitle<-gsub('.+>(.+)</a.','\\1',tmp[grep(htmlName,tmp[,2]),2]);if(length(Bigtitle)==0){Bigtitle<-''};rmarkdown::render(inputFile, encoding = encoding, output_file = paste0('C:/Users/',username,buf0[2,1],'charts/indicator/','am-consulting.co.jp-',htmlName,'.html')) })

title : "`r paste0(gsub(':|/|-','<br>',Bigtitle),'<br>http://am-consulting.co.jp')`"
output: 
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
    self_contained: false
    keep_md: no
    md_extensions: -ascii_identifiers
    includes:
       in_header: insertHeader.html
---

```{r setup, include=FALSE}
# https://stackoverflow.com/questions/43329230/r-markdown-add-tag-to-head-of-html-output/43334558#43334558
insertFile <- file("insertHeader.html")
writeLines(paste0('
<link rel="shortcut icon" href="http://knowledgevault.saecanet.com/charts/indicator/favicon-bar-chart.ico">
<link rel="stylesheet" href="am-consulting.co.jp-',htmlName,'_files/style.css" type="text/css" />'),
insertFile)
close(insertFile)
```

```{r set-options,echo=F,cache=F}
options(scipen = 999)
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
windowsFonts(Meiryo = windowsFont("Meiryo"))
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
fileName <- 
  'functionList.csv'
baseURL <- 
  'https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/'
functionList <- 
  read.csv(
    file = paste0(baseURL,'csv/',fileName),
    header = F,
    as.is = T)
for(iii in 1:nrow(functionList)){
  script <- 
    RCurl::getURL(paste0(baseURL,functionList[iii,1]),ssl.verifypeer = F)
  eval(parse(text = script))
}
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
fun_billToTri <- function(obj,dateCol = 1,valueCol = 2){
  obj <- 
    data.frame(obj[,dateCol,drop=F],apply(obj[,valueCol,drop=F],2,function(x)x*10^-4),
               stringsAsFactors = F,check.names = F,row.names = NULL)
  colnames(obj)[2] <- Nippon::zen2han(gsub('億円','兆円',colnames(obj)[2]))
  obj <- na.omit(obj)
  row.names(obj) <- NULL
  return(obj)
}
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
lag <- c(1,12,36)
legendWidth <- 300
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
if(htmlName=='00001'){
  importData <- c('importMonetarybaseOfJapan-2017.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  buf <- monetaryBase_Japan
  colnames(buf) <-
    gsub('[^:]+:(.+)','\\1',colnames(buf))
  obj <- fun_billToTri(obj = buf,valueCol = 6)
  dataSource <- "日本銀行"
  dateFormat <- '%Y-%m'
  tags <- 'マネタリーベース,日本銀行'
  diffType <- 1
  rollingN <- 12
}
if(htmlName=='00002'){
  importData <- c('importMonetarybaseOfJapan-2017.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  buf <- monetaryBase_Japan
  colnames(buf) <-
    gsub('[^:]+:(.+)','\\1',colnames(buf))
  obj <- fun_billToTri(obj = buf,valueCol = 9)
  dataSource <- "日本銀行"
  dateFormat <- '%Y-%m'
  tags <- 'マネタリーベース,日銀当座預金,日本銀行'
  diffType <- 1
  rollingN <- 12
}
if(htmlName=='00003'){
  importData <- c('importMoneyStock-2017.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  buf <- MoneyStock
  colnames(buf) <-
    gsub('[^:]+:(.+)','\\1',colnames(buf))
  obj <- fun_billToTri(obj = buf,valueCol = 10)
  dataSource <- "日本銀行"
  dateFormat <- '%Y-%m'
  tags <- 'マネーストック,日本銀行'
  diffType <- 1
  rollingN <- 12
}
if(htmlName=='00004'){
  importData <- c('importMoneyStock-2017.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  buf <- MoneyStock
  colnames(buf) <-
    gsub('[^:]+:(.+)','\\1',colnames(buf))
  obj <- fun_billToTri(obj = buf,valueCol = 11)
  dataSource <- "日本銀行"
  dateFormat <- '%Y-%m'
  tags <- 'マネーストック,日本銀行'
  diffType <- 1
  rollingN <- 12
}
if(htmlName=='00005'){
  importData <- c('importMoneyStock-2017.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  buf <- MoneyStock
  colnames(buf) <-
    gsub('[^:]+:(.+)','\\1',colnames(buf))
  obj <- fun_billToTri(obj = buf,valueCol = 13)
  dataSource <- "日本銀行"
  dateFormat <- '%Y-%m'
  tags <- 'マネーストック,日本銀行'
  diffType <- 1
  rollingN <- 12
}
if(htmlName=='00006'){
  script <-
    RCurl::getURL(
      url = "https://raw.githubusercontent.com/am-consulting/Rscript/master/laborForceSurveyofJapan.r",
      ssl.verifypeer = F)
  eval(parse(text = script))
  obj <- na.omit(origData[,c(1,17)])
  dataSource <- "総務省"
  dateFormat <- '%Y-%m'
  tags <- '失業率'
  diffType <- 2
  rollingN <- 12
}
if(htmlName=='00007'){
  importData <- c('importEmploymentReferralsForGeneralWorkers.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  obj <- na.omit(jobOpenings[,c(1,4)])
  dataSource <- "厚生労働省"
  dateFormat <- '%Y-%m'
  tags <- '有効求人倍率'
  diffType <- 2
  rollingN <- 12
}
if(htmlName=='00008'){
  script <-
    RCurl::getURL(
      "https://raw.githubusercontent.com/am-consulting/Rscript/master/consumerPriceIndexofJapan.r",
      ssl.verifypeer = FALSE)
  eval(parse(text = script))
  obj <- na.omit(consumerPriceIndexofJapan[,c(1,2)])
  dataSource <- "総務省"
  dateFormat <- '%Y-%m'
  tags <- '消費者物価指数'
  diffType <- 2
  rollingN <- 12
}
if(htmlName=='00009'){
  script <-
    RCurl::getURL(
      "https://raw.githubusercontent.com/am-consulting/Rscript/master/consumerPriceIndexofJapan.r",
      ssl.verifypeer = FALSE)
  eval(parse(text = script))
  obj <- na.omit(consumerPriceIndexofJapan[,c(1,3)])
  dataSource <- "総務省"
  dateFormat <- '%Y-%m'
  tags <- '消費者物価指数'
  diffType <- 2
  rollingN <- 12
}
if(htmlName=='00010'){
  script <-
    RCurl::getURL(
      "https://raw.githubusercontent.com/am-consulting/Rscript/master/consumerPriceIndexofJapan.r",
      ssl.verifypeer = FALSE)
  eval(parse(text = script))
  obj <- na.omit(consumerPriceIndexofJapan[,c(1,6)])
  dataSource <- "総務省"
  dateFormat <- '%Y-%m'
  tags <- '消費者物価指数'
  diffType <- 2
  rollingN <- 12
}
if(htmlName=='00011'){
  script <-
    RCurl::getURL(
      "https://raw.githubusercontent.com/am-consulting/Rscript/master/consumerPriceIndexofJapan.r",
      ssl.verifypeer = FALSE)
  eval(parse(text = script))
  obj <- na.omit(consumerPriceIndexofJapan[,c(1,79)])
  dataSource <- "総務省"
  dateFormat <- '%Y-%m'
  tags <- '消費者物価指数'
  diffType <- 2
  rollingN <- 12
}
if(htmlName=='00012'){
  tmp <-
    read.csv(file = 'http://www.stat-search.boj.or.jp/ssi/mtshtml/csv/fm08_m_1.csv',
             header = F,fileEncoding = 'shift_jis',stringsAsFactors = F)
  colnames(tmp) <- sapply(gsub('　',' ',paste0(tmp[3,],':',tmp[4,])),Nippon::zen2han)
  obj <- na.omit(tmp[-c(1:9),c(1,3)])
  obj[,1] <- as.Date(paste0(obj[,1],'/1'))
  obj[,2] <- as.numeric(obj[,2])
  colnames(obj)[1] <- 'Date'
  row.names(obj) <- NULL
  colnames(obj)[2] <- gsub('.+:(.+)','\\1',colnames(obj)[2])
  dataSource <- "日本銀行"
  dateFormat <- '%Y-%m'
  tags <- '為替レート'
  diffType <- 1
  rollingN <- 12
}
if(htmlName=='00013'){
  importData <- c('importNikkeiMonthly.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  obj <- na.omit(nikkeiMonthly[,c(1,2)])
  dataSource <- "株式会社日本経済新聞社"
  dateFormat <- '%Y-%m'
  tags <- '日経平均株価'
  diffType <- 1
  rollingN <- 12
}
if(htmlName=='00014'){
  script <-
    RCurl::getURL(
      url = "https://raw.githubusercontent.com/am-consulting/Rscript/master/Rscript_JGBInterestRate.r",
      ssl.verifypeer = F)
  eval(parse(text = script))
  objCol <- grep('2Y|10Y',colnames(jgbData))
  buf <- 
    na.omit(jgbData[,c(1,objCol)])
  buf$`10~2年物日本国債-イールドスプレッド` <- 
    buf[,3] - buf[,2]
  buf$YM <- 
    as.Date(paste0(year(buf[,1]),'-',month(buf[,1]),'-1'))
  obj <-
    aggregate(x = buf$`10~2年物日本国債-イールドスプレッド`,
              by = list(Date = buf$YM),
              FUN = mean)
  colnames(obj)[2] <-
    paste0(colnames(buf)[4],'平均値(%)')
  obj[,2] <- round(obj[,2],3)
  dataSource <- "財務省"
  dateFormat <- '%Y-%m'
  tags <- '日本国債金利'
  diffType <- 2
  rollingN <- 12
}
if(htmlName=='00015'){
  script <-
    RCurl::getURL(
      url = "https://raw.githubusercontent.com/am-consulting/Rscript/master/importGDPofJapan.r",
      ssl.verifypeer = FALSE)
  eval(parse(text = script))
  gdp1[,-1] <- apply(gdp1[,-1],2,function(x)x*10^-3)
  obj <- gdp1[,c(1,2)]
  colnames(obj)[2] <- gsub('支出側','支出側,兆円,四半期',colnames(obj)[2])
  dataSource <- "内閣府"
  dateFormat <- '%Y-%m'
  tags <- 'GDP'
  diffType <- 1
  rollingN <- 4
  lag <- c(1,4,8,12,24,36)
}
if(htmlName=='00016'){
  script <-
    RCurl::getURL(
      url = "https://raw.githubusercontent.com/am-consulting/Rscript/master/importGDPofJapan.r",
      ssl.verifypeer = FALSE)
  eval(parse(text = script))
  gdp2[,-1] <- apply(gdp2[,-1],2,function(x)x*10^-3)
  obj <- gdp2[,c(1,2)]
  colnames(obj)[2] <- gsub('支出側','支出側,兆円,四半期',colnames(obj)[2])
  dataSource <- "内閣府"
  dateFormat <- '%Y-%m'
  tags <- 'GDP'
  diffType <- 1
  rollingN <- 4
  lag <- c(1,4,8,12,24,36)
}
if(htmlName=='00017'){
  tmp <- 
    read.csv(file = 'https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/csv/csvData/TSdata/NationalGovernmentDebt.csv',
             header = F,stringsAsFactors = F,fileEncoding = 'UTF8')
  buf <- tmp[,c(1,2)]
  colnames(buf) <- buf[2,]
  buf[,2] <- as.numeric(buf[,2])*10^-4
  colnames(buf)[2] <- paste0(colnames(buf)[2],'(兆円)')
  buf <- buf[!is.na(buf[,2]),]
  buf[,1] <-
    as.Date(paste0(buf[,1],'/1'))
  colnames(buf)[1] <- 'Date'
  row.names(buf) <- NULL
  obj <- buf
  dataSource <- "日本銀行"
  dateFormat <- '%Y-%m'
  tags <- '政府債務'
  diffType <- 1
  rollingN <- 12
}
if(htmlName=='00018'){
  script <-
    RCurl::getURL(
      url = "https://raw.githubusercontent.com/am-consulting/Rscript/master/importConstructionStatistics.r",
      ssl.verifypeer = FALSE)
  eval(parse(text = script))
  obj <- SAData[,c(1,2)]
  dataSource <- "国土交通省"
  dateFormat <- '%Y-%m'
  tags <- '住宅着工件数'
  diffType <- 1
  rollingN <- 12
}
if(htmlName=='00019'){
  importData <- c('importProducerPriceIndex-2017.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  buf <- ProducerPriceIndex[,c(1,2)]
  colnames(buf) <-
    gsub('[^:]+:(.+)','\\1',colnames(buf))
  obj <- buf
  dataSource <- "日本銀行"
  dateFormat <- '%Y-%m'
  tags <- '企業物価指数,日本銀行'
  diffType <- 2
  rollingN <- 12
}
if(htmlName=='00020'){
  importData <- c('importProducerPriceIndex-2017.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  buf <- ProducerPriceIndex[,c(1,3)]
  colnames(buf) <-
    gsub('[^:]+:(.+)','\\1',colnames(buf))
  colnames(buf) <- gsub('/','~',colnames(buf))
  obj <- buf
  dataSource <- "日本銀行"
  dateFormat <- '%Y-%m'
  tags <- '企業物価指数,日本銀行'
  diffType <- 2
  rollingN <- 12
}
if(htmlName=='00021'){
  importData <- c('importProducerPriceIndex-2017.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  buf <- ProducerPriceIndex[,c(1,4)]
  colnames(buf) <-
    gsub('[^:]+:(.+)','\\1',colnames(buf))
  colnames(buf) <- gsub('/','~',colnames(buf))
  obj <- buf
  dataSource <- "日本銀行"
  dateFormat <- '%Y-%m'
  tags <- '企業物価指数,日本銀行'
  diffType <- 2
  rollingN <- 12
}
if(htmlName=='00022'){
  importData <- c('importAutoDefaultIndex.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  obj <- `auto-default`
  colnames(obj)[1] <- 'Date'
  dataSource <- "S&P Dow Jones Indices LLC"
  dateFormat <- '%Y-%m'
  diffType <- 2
  rollingN <- 12
}  
if(htmlName=='00023'){
  importData <- c('importAutoDefaultIndex.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  obj <- `bankcard-default`
  colnames(obj)[1] <- 'Date'
  dataSource <- "S&P Dow Jones Indices LLC"
  dateFormat <- '%Y-%m'
  diffType <- 2
  rollingN <- 12
}  
if(htmlName=='00024'){
  importData <- c('importAutoDefaultIndex.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  obj <- `consumer-credit-default-composite`
  colnames(obj)[1] <- 'Date'
  dataSource <- "S&P Dow Jones Indices LLC"
  dateFormat <- '%Y-%m'
  diffType <- 2
  rollingN <- 12
}  
if(htmlName=='00025'){
  importData <- c('importAutoDefaultIndex.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  obj <- `first-mortgage-default`
  colnames(obj)[1] <- 'Date'
  dataSource <- "S&P Dow Jones Indices LLC"
  dateFormat <- '%Y-%m'
  diffType <- 2
  rollingN <- 12
}  
if(htmlName=='00026'){
  importData <- c('importAutoDefaultIndex.r')
  script <-
    RCurl::getURL(paste0(baseURL,importData[1]),ssl.verifypeer = FALSE)
  eval(parse(text = script))
  obj <- `second-mortgage-default`
  colnames(obj)[1] <- 'Date'
  dataSource <- "S&P Dow Jones Indices LLC"
  dateFormat <- '%Y-%m'
  diffType <- 2
  rollingN <- 12
}  
if(htmlName=='00027'){
  script <-
    RCurl::getURL(
      url = "https://raw.githubusercontent.com/am-consulting/Rscript/master/importPERPBR.r",
      ssl.verifypeer = FALSE)
  eval(parse(text = script))
  obj <- PERPBR[,c(1,2)]
  dataSource <- "株式会社日本取引所グループ"
  dateFormat <- '%Y-%m'
  diffType <- 3
  rollingN <- 12
}
if(htmlName=='00028'){
  script <-
    RCurl::getURL(
      "https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/importMichiganData.r",
      ssl.verifypeer = F
    )
  eval(parse(text = script))
  buf <- IndexOfConsumerSentiment
  obj <- buf[which(diff(buf[,1])<=31),]
  colnames(obj)[2] <- 
    paste0('University of Michigan Consumer Sentiment Index:',colnames(obj)[2])
  colnames(obj)[2] <- gsub('([[:upper:]])', ' \\1', colnames(obj)[2])
  dataSource <- "University of Michigan"
  dateFormat <- '%Y-%m'
  diffType <- 3
  rollingN <- 12
}
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
colnames(obj) <- sapply(colnames(obj),Nippon::zen2han)
originalOBJ <- obj
switch(diffType,
  unitMark <- '%',
  unitMark <- 'PP',
  unitMark <- 'Point')
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
objWithfFit <- fun_fit(obj = obj)[,c(1,2,3)]
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
fun_latestResult(obj = obj,objColumn = 2,dateFormat = dateFormat,dateColumn = 1,orderColumn = 2)
objYear <- tail(unique(year(obj[,1])),5)[1]
ratioDF <- list()
for(cnt in seq(length(lag))){
  if(diffType==1){
    buf <- 
      fun_makeDiffRatioTable(obj = obj,lag = lag[cnt])
  }else{
    buf <- 
      fun_makeDiffTable(obj = obj,lag = lag[cnt])
  }
  colnames(buf)[2] <- 
    paste0(gsub('\\([^\\(]{0,4}[円|%]\\)','',colnames(buf)[2]),':Comparison with ',lag[cnt],' month/period(s) ago.Unit:',unitMark)
  print(tail(buf))
  ratioDF[[cnt]] <- buf
}
tsTitle <- paste0(colnames(obj)[2],':',format(tail(obj[,1],1),dateFormat),
                  '=',format(tail(obj[,2],1),big.mark = ','))
```

# Latest Result

```{r warning=F,error=F,message=F,echo=F,results='asis',out.width='100%'}
cat(paste0('<div id="htmlTitle" style="text-align:center;font-weight: bold;font-size:1.6em;">',
           tsTitle,'</div>\n\n'))
cat('\n<hr>\n')
```

```{r warning=F,error=F,message=F,echo=F,results='asis'}
cat(paste0("- Title : ",Nippon::zen2han(latestResult),'\n'))
cat(paste0("- Date : ",timeStamp,'\n'))
cat(paste0("- Source : ", dataSource,'\n'))
```
- NSA,SAの区別なくxヶ月前(x期前)との比を表示しています
- twitter https://twitter.com/AMC2_Japan
- サイトトップ http://indicator.am-consulting.co.jp/
- 本ページへのリンクを共有:<a href="https://twitter.com/share" class="twitter-share-button" data-via="AMC2_Japan" data-size="large">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


***

```{r warning=F,error=F,message=F,echo=F,results='asis',out.width='100%'}
cat('# Time Series Chart\n\n')
fun_dygraphPlot(tsData = objWithfFit,shadePattern = 3,drawPoints = c(T,F),
                width = legendWidth,fillGraph = c(F,F),pointSize = c(2,0),show = 'onmouseover',
                mainTitle = colnames(objWithfFit)[2])
cat('\n<hr>\n')
```

```{r warning=F,error=F,message=F,echo=F,results='asis'}
shadePattern <- 3;drawPoints <- c(T);width <- legendWidth;fillGraph <- c(T);pointSize <- c(2);show <- 'onmouseover'
cat('# Comparison with x month/period(s) ago\n\n')
cat('- Unit:',unitMark,'\n\n')
```

```{r warning=F,error=F,message=F,echo=F,results='asis',out.width='100%'}
chunkOutput <- NULL
for(iii in seq(length(ratioDF))){
  knit_expanded <-
    paste0(
      "\n```{r warning=F,error=F,message=F,echo=F,results='asis',out.width='100%'}\n\n",
      "cat('## x=",lag[iii],"\n\n')\n\n",
      "fun_dygraphPlot(tsData = ratioDF[[",iii,
      "]],shadePattern = shadePattern,drawPoints = drawPoints,width = width,fillGraph = fillGraph,pointSize = pointSize,show = show)\n\n",
      "cat('\n<hr>\n')")
  chunkOutput <- c(chunkOutput, knit_expanded)
}
```

`r paste(knitr::knit(text = chunkOutput),collapse = '\n')`

```{r warning=F,error=F,message=F,echo=F,results='asis',out.width='100%'}
cat('\n\n')
cat('# Moving Average\n\n')
ma <- fun_MovingAverage(obj = obj,dateFormat = dateFormat,n = rollingN,objColumn = 2,plot = 0)
fun_dygraphPlot(tsData = ma,show = 'onmouseover',axis = rep('y',3),drawPoints = c(T,F,F),pointSize = rep(2,3),fillGraph = rep(F,3),shadePattern = 3,mainTitle = paste0(colnames(ma)[2],':n=',rollingN),width = legendWidth)
cat('\n<hr>\n')
```

```{r warning=F,error=F,message=F,echo=F,results='asis',out.width='100%'}
cat('# Boxplot\n\n')
cat('## By Prime Minister of Japan\n\n')
library(plotly)
fun_withList(obj = obj)
bufDate <-
  head(dfWithList[tail(unique(dfWithList$PRIMEMINISTEROFJAPAN),7)[1]==dfWithList$PRIMEMINISTEROFJAPAN,1],1)
dfWithList <-
  dfWithList[bufDate<=dfWithList$Date,]
dfWithList$PRIMEMINISTEROFJAPAN <- 
  factor(x = dfWithList$PRIMEMINISTEROFJAPAN,
         levels = unique(dfWithList$PRIMEMINISTEROFJAPAN))
p <- 
  plot_ly(data = dfWithList,y = dfWithList[,2],color = dfWithList$PRIMEMINISTEROFJAPAN,
          type = 'box',boxpoints = "all",jitter = 0.3,pointpos = -1.8) %>% 
  config(displayModeBar = FALSE) 
mar <- list(b = 100,pad = 4)
p %>% layout(autosize = T, margin = mar)
cat('\n\n')
```

```{r warning=F,error=F,message=F,echo=F,results='asis',out.width='100%'}
cat('## By Year\n\n')
boxData <- obj
boxData$YY <- year(boxData$Date)
boxData <- boxData[tail(year(boxData$Date),1)-6<=boxData$YY,]
boxData$YY <- paste0(boxData$YY,'年')
p <- 
  plot_ly(data = boxData,y = boxData[,2],color = boxData$YY,
          type = 'box',boxpoints = "all",jitter = 0.3,pointpos = -1.8) %>% 
  config(displayModeBar = FALSE) 
mar <- list(b = 100,pad = 4)
p %>% layout(autosize = T, margin = mar)
cat('\n<hr>\n')
```

```{r warning=F,error=F,message=F,echo=F,results='asis',out.width='100%'}
fun_rolling <- function(obj = ma,h = 12,objCol = 3,plot = 0){
  resultDF <- 
    fun_changesInSlope(obj = obj,h = h,objCol = objCol,plot = plot)
  dygraphData <- 
    fun_dygraphPlot(tsData = resultDF$changesInConditions,show = 'onmouseover',
                    axis = c('y','y2'),shadePattern = 3,drawPoints = c(T,F),
                    fillGraph = c(F,T),width = legendWidth)
  if(nrow(resultDF$changesInSlope)!=0){
    changeDate <- 
      resultDF$changesInSlope[,1]
    changeDateDF <-
      data.frame(format(changeDate,dateFormat),c('*',diff(year(changeDate)*12+month(changeDate))),
                 stringsAsFactors = F)
    colnames(changeDateDF) <-
      c('Point of Change','Month/Period Difference')
    tmp <- 
      cbind(summary(as.numeric(tail(changeDateDF[,2],-1))))
    summaryData <-
      data.frame(Item=row.names(tmp),Value=tmp[,1],
                 row.names = NULL,stringsAsFactors = F)
  }else{
    changeDateDF <- NA
    summaryData <-NA
  }
  returnList <-
      list('dygraphData' = dygraphData,
           'changeDateDF' = changeDateDF,
           'summaryData' = summaryData)
  return(returnList)
}
```

```{r warning=F,error=F,message=F,echo=F,results='asis',out.width='100%'}
cat('# Rolling Regression\n\n')
cat('- The Width of the rolling window(months/periods):',rollingN,'\n\n')
cat('## SMA\n\n')
objCol <- 3
returnList <- fun_rolling(obj = ma,objCol = objCol,h = rollingN)
returnList$dygraphData
cat('\n<hr>\n')
if(!is.na(returnList$changeDateDF)){
  # fun_markdownTable(obj = returnList$changeDateDF)
  # cat('\n<hr>\n')
  # fun_markdownTable(obj = returnList$summaryData)
  # cat('\n\n')
  SMAresult <- na.omit(as.numeric(returnList$changeDateDF$`Month/Period Difference`))
}
cat('## EMA\n\n')
objCol <- 4
returnList <- fun_rolling(obj = ma,objCol = objCol,h = rollingN)
returnList$dygraphData
cat('\n<hr>\n')
if(!is.na(returnList$changeDateDF)){
  # fun_markdownTable(obj = returnList$changeDateDF)
  # cat('\n<hr>\n')
  # fun_markdownTable(obj = returnList$summaryData)
  # cat('\n<hr>\n')
  EMAresult <- na.omit(as.numeric(returnList$changeDateDF$`Month/Period Difference`))
}
if((length(SMAresult)+length(EMAresult))!=0){
  cat('## Interval between Changing Point\n\n')
  bothResult <- matrix(ncol=2)
  if(length(SMAresult)!=0){
    bothResult <- rbind(cbind(SMAresult,'SMA'),bothResult)
  }
  if(length(EMAresult)!=0){
    bothResult <- rbind(cbind(EMAresult,'EMA'),bothResult)
  }
  bothResult <- 
    data.frame(na.omit(bothResult),stringsAsFactors = F,row.names = NULL)
  bothResult[,1] <- as.numeric(bothResult[,1])
  colnames(bothResult) <- 
    c('Interval between Changing Point','Moving Average')
  p <- 
    plot_ly(data = bothResult,y=bothResult[,1],color = bothResult[,2],
            type = 'box',boxpoints = "all",jitter = 0.3,pointpos = -1.8) %>% 
    config(displayModeBar = FALSE) 
  mar <- list(b = 50,pad = 4)
  p %>% layout(autosize = T, margin = mar,title = colnames(bothResult)[1])
}
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
fun_timeSeriesList(tsTitle = tsTitle,htmlName = htmlName)
```

<script>MakeNegative();</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3077339-5', 'auto');
  ga('send', 'pageview');

</script>
