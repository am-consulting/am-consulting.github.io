```{r }
windowsFonts(Meiryo = windowsFont("Meiryo"))
options(scipen = 100)
library(ggplot2);library(lubridate)
pngWidth <- 1000
pngHeight <- 600
```

```{r}
fileName <- 
  'functionList.csv'
baseURL <- 
  'https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/'
functionList <- 
  read.csv(
    file = paste0(baseURL,'csv/',fileName),
    header = F,
    as.is = T)
for(iii in 1:nrow(functionList)){
  script <- 
    RCurl::getURL(paste0(baseURL,functionList[iii,1]),ssl.verifypeer = F)
  eval(parse(text = script))
}
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
userName <- Sys.info()['user']
fileName <- 'defaultPath.csv'
pathToFile <-
  paste0('C:/Users/',userName,'/Desktop/pathToCSV/')
setwd(pathToFile)
buf0 <-
  read.csv(fileName,header = F,skip = 0,stringsAsFactor = F,check.names = F,
           fileEncoding = 'UTF8')
pathOutputJGB <- paste0('C:/Users/',userName,buf0[2,1],'charts/indicator/JGByieldCurve/')
```

```{r}
dataSource <- 'Ministry of Finance Japan'
script <-
  RCurl::getURL(
    url = "https://raw.githubusercontent.com/am-consulting/Rscript/master/Rscript_JGBInterestRate.r",
    ssl.verifypeer = F)
eval(parse(text = script))
jgbDataNoOmit <- jgbData
jgbData <- na.omit(jgbData)
row.names(jgbData) <- NULL
yearList <- unique(year(jgbData$Date))
cnt <- 0
for(yyyy in yearList){
  buf0 <- jgbData[year(jgbData$Date)==yyyy,]
  for(mm in 1:12){
    buf1 <- buf0[month(buf0$Date)==mm,]
    if(nrow(buf1)!=0){
      cnt <- cnt + 1
      if(cnt == 1){yieldDF0 <- tail(buf1,1)}else{yieldDF0 <- rbind(yieldDF0,tail(buf1,1))}
    }
  }
}
row.names(yieldDF0) <- NULL
fun_withList(obj = yieldDF0)
yieldDF <- dfWithList[,c(1,
                         grep('primeministerofjapan',colnames(dfWithList),ignore.case = T),
                         grep('[0-9]{1,2}',colnames(dfWithList)))]
```

```{r}
fontSize <- 15
output <- 1
chartName <- pmName <- vector()
for(rrr in seq(nrow(yieldDF))){
  if(output!=0){
    setwd(pathOutputJGB)
    pngN <- formatC(rrr,width = 3,format = "d",flag = "0")
    pngFile <- paste0('JGBcurve-',pngN,".png")
    png(file = pngFile,width = pngWidth,height = pngHeight)
  }
  chartName[rrr] <- as.character(yieldDF[rrr,1])
  pmName[rrr] <- yieldDF[rrr,2]
  obj <- 
    data.frame(Year = colnames(yieldDF)[-c(1,2)],
               Yield = as.numeric(t(yieldDF[rrr,-c(1,2)])[,1]),
               check.names = F,row.names = NULL,stringsAsFactors = F)
  obj[,1] <-factor(obj[,1],levels = obj[,1])
  g <- ggplot(obj,aes(x=factor(Year),y=Yield,group=1))
  g <- g + geom_line(size=0.1)
  g <- g + geom_point(size=3)
  g <- g + ylim(min(yieldDF[,-c(1,2)]),max(yieldDF[,-c(1,2)]))
  g <- g + geom_smooth(method = lm,lwd = 1,col = "red")
  g <- g + xlab('')
  g <- g + ylab('')
  g <- g + ggtitle(paste0('Japanese Government Bond Yield Curve\n',
                          as.character(chartName[rrr]),
                          '. Prime Minister of Japan:',pmName[rrr],'\nSource:',dataSource))
  g <- g + theme(plot.title = element_text(family = "Meiryo",hjust = 0.5,size = fontSize))
  g <- g + theme(axis.title.x = element_text(family = "Meiryo",size = fontSize))
  g <- g + theme(axis.title.y = element_text(family = "Meiryo",size = fontSize))
  g <- g + theme(axis.text.x = element_text(family = "Meiryo",size = fontSize, angle = 0))
  g <- g + theme(axis.text.y = element_text(family = "Meiryo",size = fontSize, angle = 90))
  g <- g + geom_hline(yintercept = 0,col = 'blue')
  print(g)
  if(output!=0){dev.off()}
}
```

```{r warning=F,error=F,message=F,echo=F,results='asis'}
fun_outputHtmlFile <- function(obj){
  JGByieldDF <- data.frame()
  objRaw <- 0
  colN <- 4
  cnt <- 0
  for(rrr in seq(1,nrow(obj),by = colN)){
    objRaw <- objRaw + 1
    objCol <- 0
    for(ccc in rrr:(rrr+colN-1)){
      txt <- ''
      num <- formatC(ccc,width = 3,format = "d",flag = "0")
      txt <- 
        paste0(txt,
               '<a href="http://indicator.am-consulting.co.jp/JGByieldCurve/JGBcurve-',num,'.png">')
      txt <- 
        paste0(txt,
               '<img border="2" src="http://indicator.am-consulting.co.jp/JGByieldCurve/JGBcurve-',
               num,'.png" width="30%" />')
      txt <- 
        paste0(txt,'<b>',obj[ccc,1],'</b></a>')
      objCol <- objCol + 1
      JGByieldDF[objRaw,objCol] <- txt
      cnt <- cnt + 1
      if(cnt==nrow(yieldDF)){break}
    }
  }
  colnames(JGByieldDF) <- rep('Yield Curve Chart',colN)
  setwd(pathOutputJGB)
  write.csv(x = JGByieldDF,file = 'JGByield.csv',quote = T,
            row.names = F,append = F,na = '',fileEncoding = 'UTF-8',qmethod = 'double')
  return(JGByieldDF)
}
JGByieldChart <- fun_outputHtmlFile(obj = yieldDF[,-2])
```

```{r warning=F,error=F,message=F,echo=F,results='asis'}
setwd(pathOutputJGB)
JGByieldChart[is.na(JGByieldChart)] <- ''
tableTxt <-
  paste0(knitr::kable(x = JGByieldChart,row.names = F,format = 'html',
               table.attr = "class = 'amcc' width = '100%'",
               format.args = list(big.mark = ',',drop0trailing = T),escape = F))
write.table(x = tableTxt,file = 'JGByieldCurve.html',append = F,
            fileEncoding = 'utf8',col.names = F,row.names = F,quote = F)
```
