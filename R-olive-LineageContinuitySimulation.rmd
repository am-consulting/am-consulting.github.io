---
knit: (function(inputFile, encoding) {username<-Sys.info()['user'];fileName<-'defaultPath.csv';pathToFile <-paste0('C:/Users/', username,'/Desktop/pathToCSV/');setwd(pathToFile);buf0<-read.csv(fileName,header = F,skip = 0,stringsAsFactor = F,check.names = F,fileEncoding = 'utf-8');rmarkdown::render(inputFile, encoding = encoding, output_file = paste0('C:/Users/',username,buf0[2,1],'charts/','am-consulting.co.jp-lineageContinuitySimulation.html')) })

title : 'Lineage Continuity Simulation'
author: "アセット･マネジメント･コンサルティング株式会社 http://am-consulting.co.jp"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: 
  html_document:
    fig_height: 6
    fig_width: 10
    keep_md: no
    md_extensions: -ascii_identifiers
---
<link href="http://knowledgevault.saecanet.com/components/rmarkdown-html.css" rel="stylesheet">
<script src="http://knowledgevault.saecanet.com/components/JavascriptCode.js"></script>
<style>.main-container {max-width : 900px;}</style>

```{r warning=F, error=F, message=F, echo=F, results='hold'}
library(DT)
library(lubridate)
dataTitle <- 
  '一組の夫婦が授かる子供の人数と男子が誕生する確率に基づく系統連続性シミュレーション'
```

***

- `r paste0("タイトル : ", dataTitle)`

***

```{r warning=F, error=F, message=F, echo=F, results='hide'}
fun_simulation <-
  function(probability_Boy = 0.5, # 男子が誕生する確率
           childrenNumber = 2, # 授かる子供の人数
           lastGeneration = 10, # 第lastGeneration代迄系統が継続するか否か
           needGTable = 1,
           simN = 50){ # シミュレーション回数 
    probability_Girl <- 
      1 - probability_Boy
    cnt <- 0
    for(test in 1:simN){
      gc();gc();
      maleN <- 1 # 第1世代の男の数:最初の夫婦一組
      femaleN <- 2- maleN # 第1世代の女の数:最初の夫婦一組
      generationN <- 1 # 第1世代
      buf <- data.frame()
      buf[generationN, 1] <- generationN
      buf[generationN, 2] <- maleN
      buf[generationN, 3] <- femaleN
      buf[generationN, 4] <- maleN + femaleN
      while(maleN != 0){
        generationN <- generationN + 1
        children <- 
          sample(x = c('Boy', 'Girl'),
                 size = childrenNumber * maleN,
                 replace = T,
                 prob = c(probability_Boy, probability_Girl))
        
        maleN <- 
          length(grep('Boy', children))
        femaleN <- length(children) - maleN
        if(needGTable == 1){
          buf[generationN, 1] <- generationN
          buf[generationN, 2] <- maleN
          buf[generationN, 3] <- femaleN
          buf[generationN, 4] <- maleN + femaleN
        }
        if ((lastGeneration + 1) == generationN & maleN != 0) { # 第lastGeneration代迄が継続した場合
          cnt <- cnt + 1
          break
        }
      }
      colnames(buf) <- 
        c('第X世代', '男の人数', '女の人数', '男女合計人数')
      # print(buf)
      if(nrow(buf) <= ceiling(lastGeneration/2)){
        assign('failExample', buf, envir = .GlobalEnv) 
        assign('failTest', test, envir = .GlobalEnv)
      }
      if(nrow(buf) == (lastGeneration + 1)){
        assign('successExample', buf, envir = .GlobalEnv) 
        assign('successTest', test, envir = .GlobalEnv)
      }
      assign(paste0('generationTable',test), buf, envir = .GlobalEnv)
    }
    assign('simulationResult',
           paste0(cnt, ' / ', test, ' = ', round(cnt / simN * 100, 2), '%'),
           envir = .GlobalEnv)
    assign('countResult', cnt, envir = .GlobalEnv)
  }
```

```{r warning=F, error=F, message=F, echo=F, results='hide'}
funDataTable <- 
  function(obj,
           captionText = '',
           rowName = F){
    DT::datatable(
    obj,
    options = list(
      search.regex = F,
      paging = F,
      autoWidth = F,
      info = F,
      lengthChange = F,
      ordering = F,
      searching = F,
      scrollX = F,
      orderClasses = T
    ),
    rownames = rowName,
    caption = captionText,
    class = 'display compact'
    )
  }
resultOutput01 <- 
  function(){
    cat(paste0(
    '1組の夫婦が生涯で授かる子供の人数を', childrenNumber, '人、<br>',
    '男子が誕生する確率を', probability_Boy * 100, '%とし、<br>',
    '同一条件のもと', simN, '回のシミュレーションの結果、<br>',
    lastGeneration, '世代連続で少なくとも1人は第1世代に連なる男子の系統の男子が存在したのは', countResult, '回、<br>','
    比率は', simulationResult, '。'))
  }
```

#### シミュレーション前提

1. 一夫一婦とし、授かる子供の人数と男子を授かる確率は世代や夫婦その他条件に依らず一組のシミュレーションにおいては一定とする。
1. 最初の一組の夫婦を第1世代と名付ける。
1. 第1世代に連なる男子の系統の男子がある世代まで継続するか否かをシミュレーション。

***
<div align="center"><h3><b>シミュレーション結果</b></h3></div>
<h4><Font color="blue"><b>Pattern Blue</b></font></h4>

```{r warning=F, error=F, message=F, echo=F, results='asis'}
lastGeneration <- 10
simN <- 50
probability_Boy <- 0.5
childrenNumber <- 4
fun_simulation(probability_Boy = probability_Boy,
               childrenNumber = childrenNumber,
               lastGeneration = lastGeneration,
               simN = simN)
resultOutput01()
if(countResult < simN){
  cat('<br><br>')
  cat(paste0('<b>',lastGeneration+1, '世代迄継続されなかったケース。 シミュレーション',failTest,'回目</b>'))
  funDataTable(failExample)
}
if(countResult != 0){
  cat('<br><br>')
  cat(paste0('<b>',lastGeneration+1, '世代迄継続されたケース。 シミュレーション',successTest,'回目</b>'))
  funDataTable(successExample)
}
```

***
<h4><Font color="#622d18"><b>Pattern Sepia</b></font></h4>

```{r warning=F, error=F, message=F, echo=F, results='asis'}
probability_Boy <- 0.5
childrenNumber <- 3
fun_simulation(probability_Boy = probability_Boy,
               childrenNumber = childrenNumber,
               lastGeneration = lastGeneration,
               simN = simN)
resultOutput01()
if(countResult < simN){
  cat('<br><br>')
  cat(paste0('<b>',lastGeneration+1, '世代迄継続されなかったケース。 シミュレーション',failTest,'回目</b>'))
  funDataTable(failExample)
}
if(countResult != 0){
  cat('<br><br>')
  cat(paste0('<b>',lastGeneration+1, '世代迄継続されたケース。 シミュレーション',successTest,'回目</b>'))
  funDataTable(successExample)
}
```

***
<h4><Font color="orange"><b>Pattern Orange</b></font></h4>

```{r warning=F, error=F, message=F, echo=F, results='asis'}
probability_Boy <- 0.5
childrenNumber <- 2
fun_simulation(probability_Boy = probability_Boy,
               childrenNumber = childrenNumber,
               lastGeneration = lastGeneration,
               simN = simN)
resultOutput01()
if(countResult < simN){
  cat('<br><br>')
  cat(paste0('<b>',lastGeneration+1, '世代迄継続されなかったケース。 シミュレーション',failTest,'回目</b>'))
  funDataTable(failExample)
}
if(countResult != 0){
  cat('<br><br>')
  cat(paste0('<b>',lastGeneration+1, '世代迄継続されたケース。 シミュレーション',successTest,'回目</b>'))
  funDataTable(successExample)
}
```

***
<h4><Font color="red"><b>Pattern Red</b></font></h4>

```{r warning=F, error=F, message=F, echo=F, results='asis'}
probability_Boy <- 0.5
childrenNumber <- 1
fun_simulation(probability_Boy = probability_Boy,
               childrenNumber = childrenNumber,
               lastGeneration = lastGeneration,
               simN = simN)
resultOutput01()
if(countResult < simN){
  cat('<br><br>')
  cat(paste0('<b>',lastGeneration+1, '世代迄継続されなかったケース。 シミュレーション',failTest,'回目</b>'))
  funDataTable(failExample)
}
if(countResult != 0){
  cat('<br><br>')
  cat(paste0('<b>',lastGeneration+1, '世代迄継続されたケース。 シミュレーション',successTest,'回目</b>'))
  funDataTable(successExample)
}
```

***
### 「男子誕生確率」×「授かる子供の人数」のシミュレーション
#### `r paste0('シミュレーション回数は', simN, '回。', lastGeneration + 1,'世代迄継続した割合')`

```{r warning=F, error=F, message=F, echo=F, results='asis'}
resultTable <- data.frame()
childrenNumber <- 
  c(1, 2, 3, 4)
probability_Boy <- 
  c(0.45, 0.5, 0.55)
for(ccc in 1:length(childrenNumber)){
  for(ppp in 1:length(probability_Boy)){
    gc();gc()
    fun_simulation(probability_Boy = probability_Boy[ppp],
                   childrenNumber = childrenNumber[ccc],
                   lastGeneration = lastGeneration,
                   simN = simN)
    resultTable[ppp, ccc] <- simulationResult
  }
}
colnames(resultTable) <- 
  paste0('授かる子供の数=', childrenNumber)
rownames(resultTable) <- 
  paste0('男子が生まれる確率=', probability_Boy)
funDataTable(obj = resultTable,
             rowName = T)
```

***
<script>MakeNegative()</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3077339-5', 'auto');
  ga('send', 'pageview');

</script>
