---
knit: (function(inputFile, encoding) {username<-Sys.info()['user'];fileName<-'defaultPath.csv';pathToFile <-paste0('C:/Users/', username,'/Desktop/pathToCSV/');setwd(pathToFile);buf0<-read.csv(fileName,header = F,skip = 0,stringsAsFactor = F,check.names = F,fileEncoding = 'utf-8');rmarkdown::render(inputFile, encoding = encoding, output_file = paste0('C:/Users/',username,buf0[2,1],'charts/','am-consulting.co.jp-lineageContinuitySimulation.html')) })

title : 'Lineage Continuity Simulation'
author: "アセット･マネジメント･コンサルティング株式会社 http://am-consulting.co.jp"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: 
  html_document:
    fig_height: 6
    fig_width: 10
    keep_md: no
    md_extensions: -ascii_identifiers
---
<link href="http://knowledgevault.saecanet.com/components/rmarkdown-html.css" rel="stylesheet">
<script src="http://knowledgevault.saecanet.com/components/JavascriptCode.js"></script>
<style>.main-container {max-width : 1000px;}</style>

```{r,warning=F,error=F,message=F,results='hold'}
library(DT)
library(lubridate)
dataTitle <- 
  '一組の夫婦が授かる子供の人数と男子または女子が誕生する確率に基づく系統連続性シミュレーション'
childrenNumber <- 
  c(1, 2, 3, 4)
probability_Boy <- 
  c(0.45, 0.5, 0.55)
```

***

- `r paste0("タイトル : ", dataTitle, latestResult)`

***

```{r warning=F,error=F,message=F,results='hide'}
fun_simulation <-
  function(probability_Boy = 0.5, # 男子が誕生する確率
           childrenNumber = 2, # 授かる子供の人数
           lastGeneration = 10, # 第lastGeneration代迄系統が継続するか否か
           needGTable = 1,
           simN = 50){ # シミュレーション回数 
    probability_Girl <- 
      1 - probability_Boy
    cnt <- 0
    for(test in 1:simN){
      gc();gc();
      maleN <- 1 # 第1世代の男の数:最初の夫婦一組
      femaleN <- 2- maleN # 第1世代の女の数:最初の夫婦一組
      generationN <- 1 # 第1世代
      buf <- data.frame()
      buf[generationN, 1] <- generationN
      buf[generationN, 2] <- maleN
      buf[generationN, 3] <- femaleN
      buf[generationN, 4] <- maleN + femaleN
      while(maleN != 0){
        generationN <- generationN + 1
        children <- 
          sample(x = c('Boy', 'Girl'),
                 size = childrenNumber * maleN,
                 replace = T,
                 prob = c(probability_Boy, probability_Girl))
        
        maleN <- 
          length(grep('Boy', children))
        femaleN <- length(children) - maleN
        if(needGTable == 1){
          buf[generationN, 1] <- generationN
          buf[generationN, 2] <- maleN
          buf[generationN, 3] <- femaleN
          buf[generationN, 4] <- maleN + femaleN
        }
        if ((lastGeneration + 1) == generationN & maleN != 0) { # 第lastGeneration代迄が継続した場合
          cnt <- cnt + 1
          break
        }
      }
      colnames(buf) <- 
        c('第X世代', '男の人数', '女の人数', '男女合計人数')
      print(buf)
      assign(paste0('generationTable',test), buf, envir = .GlobalEnv)
    }
    assign('simulationResult',
           paste0(cnt, ' / ', test, ' = ', round(cnt / test * 100, 2), '%'),
           envir = .GlobalEnv)
  }
```

```{r warning=F,error=F,message=F,results='hide'}
funDataTable <- 
  function(obj,
           captionText = '',
           rowName = F){
    DT::datatable(
    obj,
    options = list(
      search.regex = F,
      paging = F,
      autoWidth = F,
      info = F,
      lengthChange = F,
      ordering = F,
      searching = F,
      scrollX = F,
      orderClasses = T
    ),
    rownames = rowName,
    caption = captionText,
    class = 'display compact'
    )
  }
resultOutput01 <- 
  function(){
    cat(
    '1組の夫婦が生涯で授かる子供の人数を',
    childrenNumber,
    '人、\n男子が誕生する確率を',
    probability_Boy * 100,
    '%とし、\n以降同一条件のもとその後',
    lastGeneration,
    '世代連続で少なくとも1人は第1世代に連なる男子の系統の男子が存在している確率は\n',
    simN,
    '回のシミュレーションの結果、',
    simulationResult,
    '\n(a/b=Z%.aは',
    lastGeneration,
    '世代連続で少なくとも1人は第1世代に連なる男子の系統の男子が存在した回数、bはシミュレーション総回数).'
  )
}
resultOutput02 <- 
  function(){
  chkResult <- get(paste0('generationTable0', simuN))
  generationResult <- nrow(chkResult)
  if (chkResult[nrow(chkResult), 2] == 0) {
    generationResult <- generationResult - 1
  }
  buf_captionText <<- paste(
    '男子誕生確率(%):',
    buf_probBoy * 100,
    '、夫婦が授かる子どもの人数:',
    buf_childrenN,
    '、',
    generationResult,
    '世代目まで連続して少なくとも1人は第0世代に連なる男子の系統の男子が存在.'
  )
}
```

#### シミュレーション前提

1. 一夫一婦とし、授かる子供の人数と男子を授かる確率は世代や夫婦その他条件に依らず一組のシミュレーションにおいては一定とする。
1. 最初の一組の夫婦を第1世代と名付ける。
1. 第1世代に連なる男子の系統の男子がある世代まで継続するか否かをシミュレーション。

#### 表の見方
1. 例えば授かる子供の人数が4人の場合、第1世代の合計人数は第0世代が授かった子供の人数=4人となる。
1. 次に男子を授かる確率に基づき男女の人数をシミュレーション。例えば男子の人数=2人、女子の人数=2人。
1. 第2世代の合計人数は第1世代の"男子の人数"に、授かる子供の人数を乗じた人数となる。第1世代の男子の人数が2人の場合、合計人数は2×4=8人。
1. 再び男子を授かる確率に基づき男女の人数をシミュレーション。例えば男子の人数=3人、女子の人数=5人。
1. 以降の世代も同様とし、表中最下行の世代の男子の人数が0でない場合、設定した世代まで第0世代に連なる男子の系統の男子が継続したと判定。

***
#### シミュレーション例

```{r warning=F,error=F,message=F,results='hold'}
probability_Boy <- 0.5
childrenNumber <- 4
lastGeneration <- 10
simN <- 100
fun_simulation(probability_Boy = probability_Boy,
               childrenNumber = childrenNumber,
               lastGeneration = lastGeneration,
               simN = simN)
```

***
<script>MakeNegative()</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3077339-5', 'auto');
  ga('send', 'pageview');

</script>
