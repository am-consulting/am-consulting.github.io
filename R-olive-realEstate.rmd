---
knit: (function(inputFile, encoding) {username<-Sys.info()['user'];fileName<-'defaultPath.csv';pathToFile <-paste0('C:/Users/', username,'/Desktop/pathToCSV/');setwd(pathToFile);buf0<-read.csv(fileName,header = F,skip = 0,stringsAsFactor = F,check.names = F,fileEncoding = 'utf-8');timeStamp<-format(Sys.time(),'%Y%m%d%H%M%S');targetPre<-13;htmlFile<-paste0('C:/Users/',username,buf0[2,1],'charts/','am-consulting.co.jp-RealEstateAnalysis-UsedCondo-',formatC(targetPre,width=2,flag='0'),'.html');rmarkdown::render(inputFile, encoding = encoding, output_file = htmlFile) })

title : "Real-Estate Value In Japan:Tokyo:Second-hand Apartment"
author: "アセット･マネジメント･コンサルティング株式会社 http://am-consulting.co.jp"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: 
  html_document:
    fig_height: 6
    fig_width: 10
    keep_md: no
    md_extensions: -ascii_identifiers 
---
<link href="http://knowledgevault.saecanet.com/components/rmarkdown-html.css" rel="stylesheet">
<script src="http://knowledgevault.saecanet.com/components/JavascriptCode.js"></script>
<style>.main-container {max-width : 1000px;}</style>

 - アセット･マネジメント･コンサルティング株式会社 http://am-consulting.co.jp
 - SaECaNet http://saecanet.com/
 - Olive http://olive.saecanet.com/
 - twitter https://twitter.com/AMC2_Japan

本ページへのリンクを共有:<a href="https://twitter.com/share" class="twitter-share-button" data-via="AMC2_Japan" data-size="large">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

```{r set-options, echo=F, cache=F}
options(width = 1000)
```

```{r,warning=F,error=F,message=F,results='hold',echo=F}
windowsFonts(Meiryo = windowsFont("Meiryo"))
options(scipen = 999)
library(lubridate)
library(knitr)
library(Nippon)
```

```{r,warning=F,error=F,message=F,echo=F}
library(RCurl)
importAMCC <- 
  c('R-dygraphsFunction.r','R-dataTablesFunction.r','R-turningPoint.r','R-scatterPlot.r',
    'transposeDataFrame.r','R-fit.r','plotTimeSeries.r','R-turningPoint.r',
    'timeSeriesDataFundamentalStatistics.r',
    'R-getLatestResult.r','R-markdownTable.r','R-makeDiffTable.r')
for(iii in 1:length(importAMCC)){
  script <- getURL(
    paste0("https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/", importAMCC[iii]),
    ssl.verifypeer = F
  )
  eval(parse(text = script))
}
```

```{r,warning=F,error=F,message=F,echo=F}
prefecture = c('北海道', '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県', '茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県', '新潟県', '富山県', '石川県', '福井県', '山梨県', '長野県', '岐阜県', '静岡県', '愛知県', '三重県', '滋賀県', '京都府', '大阪府', '兵庫県', '奈良県', '和歌山県', '鳥取県', '島根県', '岡山県', '広島県', '山口県', '徳島県', '香川県', '愛媛県', '高知県', '福岡県', '佐賀県', '長崎県', '熊本県', '大分県', '宮崎県', '鹿児島県', '沖縄県')
```

```{r,warning=F,error=F,message=F,results='hold',echo=F}
targetFolder <- 'All_20162_20162'
targetRealEstateType <- '中古マンション等'
```

```{r,warning=F,error=F,message=F,results='hold',echo=F}
dataTitle <- 
  paste0('不動産取引価格情報の計量分析-', '2016年度第2四半期-', prefecture[targetPre], '-',
         targetRealEstateType)
dataSource <- '国土交通省:不動産取引価格情報'
notes <- '複数のワードで検索する際は半角スペースで区切ってください'
notes0 <- "表中、-9999はNAを意味します"
Author <- "アセット･マネジメント･コンサルティング株式会社 http://am-consulting.co.jp"
```

***

- `r paste0("タイトル : ", dataTitle)`
- `r paste0("データ出所 : ", dataSource)`
- Source http://www.land.mlit.go.jp/webland/download.html

***

```{r,warning=F,error=F,message=F,echo=F}
username <- Sys.info()['user']
pathTOdata <- paste0("C:/Users/", username, "/Desktop/", targetFolder, '/')
csvList <- dir(pathTOdata)
```

```{r,warning=F,error=F,message=F,results='hide',echo=F}
tmp0 <-
  read.csv(
    file = paste0(pathTOdata, csvList[targetPre]),
    na.strings = c(""),
    stringsAsFactors = F,
    check.names = F
  )
colnames(tmp0)
# 対象とする不動産種類を抽出 
tmp1 <- 
  tmp0[grep(targetRealEstateType, tmp0[, 2], ignore.case = T),]
colnames(tmp1) <- 
  sapply(colnames(tmp1), zen2han)
colnames(tmp1)
type <- 
  grep('^種類\\b', colnames(tmp1))
city0 <- 
  grep('市区町村名', colnames(tmp1))
city1 <- 
  grep('地区名', colnames(tmp1))
torihikikakaku_sougaku <- 
  grep('取引価格\\(総額\\)', colnames(tmp1))
menseki <- 
  grep('\\b面積\\(㎡\\)', colnames(tmp1))
kenchikuYear <- 
  grep('建築年', colnames(tmp1))
kouzou <- 
  grep('建物の構造', colnames(tmp1))
youtochiiki <- 
  grep('都市計画', colnames(tmp1))
# 建築年が記載されているデータのみを対象とする
tmp2 <- 
  tmp1[!is.na(tmp1[, kenchikuYear]),]
gengou <-  
  substring(tmp2[, kenchikuYear], 1, 2)
yy <-
  substring(tmp2[, kenchikuYear], 3, nchar(tmp2[, kenchikuYear]) - 1)
buf1 <- 
  data.frame(gengou,
             yy,
             stringsAsFactors = F,
             check.names = F)
for (rrr in 1:nrow(buf1)){
  if(buf1[rrr, 1] == '昭和'){
    yyyy <- as.numeric(buf1[rrr, 2]) + 1925
    }else{
      if(substring(buf1[rrr, 2], 1, 1) != '元'){
        yyyy <- as.numeric(buf1[rrr, 2]) + 1988
        }else{
          yyyy <- 1989
        }
    }
  buf1[rrr, 3] <- yyyy
}
tmp3 <- 
  data.frame(tmp2,
             buf1[, 3],
             stringsAsFactors = F,
             check.names = F)
colnames(tmp3)[ncol(tmp3)] <-  
  '建築年(西暦)'
tmp4 <- 
  data.frame(tmp3,
             year(Sys.Date()) - tmp3[, ncol(tmp3)],
             stringsAsFactors = F,
             check.names = F)
colnames(tmp4)[ncol(tmp4)] <- 
  '築年数'
chikunensuu <- 
  grep('築年数', colnames(tmp4))
tmp5 <- 
  data.frame(tmp4,
             round(tmp4[, torihikikakaku_sougaku] / as.numeric(tmp4[, menseki]), -3),
             check.names = F,
             stringsAsFactors = F)
colnames(tmp5)[ncol(tmp5)] <- 
  gsub('\\(総額\\)', '(総額:平米単価(円))', colnames(tmp5)[torihikikakaku_sougaku])
torihikikakaku_sougaku_heibeitanka <- 
  grep('総額:平米単価\\(円\\)', colnames(tmp5))
dataSet0 <- tmp5
```

#### 築年数 × 取引価格(総額:平米単価(円))

```{r,warning=F,error=F,message=F,echo=F,fig.height=12,results='asis'}
par(mar = c(7,5,5,5), family = 'Meiryo', mfrow = c(3,2), oma = c(0,0,0,0))
for(ppp in 1:3){
  dataSet <- dataSet0
  mainTitle <-
    paste0(colnames(dataSet)[chikunensuu], ' × ', colnames(dataSet)[torihikikakaku_sougaku_heibeitanka])
  if(ppp != 1){
    meanPrice <- 
      mean(dataSet[, torihikikakaku_sougaku_heibeitanka])
    sdPrice <- 
      sd(dataSet[, torihikikakaku_sougaku_heibeitanka])
    dataSet <-
      subset(dataSet,
             meanPrice - ppp * sdPrice <= dataSet[, torihikikakaku_sougaku_heibeitanka] & 
               dataSet[, torihikikakaku_sougaku_heibeitanka] <= meanPrice + ppp * sdPrice)
    mainTitle <- 
      paste0(mainTitle, '\n外れ値(±', ppp, 'σ)除去')
  }
  dataSet$cityColor <- 
    apply(dataSet[,city0,drop=F], 2,
          function(x)  match(x,unique(dataSet[,city0])))
  Chikunensuu <- 
    dataSet[, chikunensuu]
  Torihikikakaku_sougaku_heibeitanka <- 
    dataSet[, torihikikakaku_sougaku_heibeitanka]
  glmResult <- 
    lm(Torihikikakaku_sougaku_heibeitanka ~ Chikunensuu)
  plot(
    dataSet[, chikunensuu],
    dataSet[, torihikikakaku_sougaku_heibeitanka],
    type = 'p',
    col = dataSet$cityColor,
    xlab = '',
    ylab = paste0(colnames(dataSet)[torihikikakaku_sougaku_heibeitanka]),
    main = paste(mainTitle),
    cex.axis = 1.2,
    cex.lab = 1.5,
    cex.main = 1.5,
    cex.sub=1.5,
    lwd = 1,
    sub = 
      paste0(
        colnames(dataSet)[torihikikakaku_sougaku_heibeitanka],
        ' = ',
        round(glmResult$coefficients[2]),
        ' × ',
        colnames(dataSet)[chikunensuu],
        ' + ',
        round(glmResult$coefficients[1]))
    )
  title(xlab = paste0(colnames(dataSet)[chikunensuu]), line = 2.5, cex.lab = 1.5)
  panel.first = grid(nx = NULL, ny = NULL, lty = 2, equilogs = T) 
  abline(lm(dataSet[,torihikikakaku_sougaku_heibeitanka] ~ dataSet[,chikunensuu]), col = 'red', lwd = 2)
  mainTitle <- 
    paste0('ヒストグラム:', colnames(dataSet)[torihikikakaku_sougaku_heibeitanka])
  if (ppp != 1) {
    mainTitle <- paste0(mainTitle, '\n外れ値(±', ppp, 'σ)除去')
  }
  hist(dataSet[, torihikikakaku_sougaku_heibeitanka],
       xlab = colnames(dataSet)[torihikikakaku_sougaku_heibeitanka],
       col = '#ADD8E6',
       main = mainTitle,
       cex.axis = 1,
       cex.lab = 1.5,
       cex.main = 1.5
       )
  panel.first = grid(nx = NULL, ny = NULL, lty = 2, equilogs = T) 
}
```

#### 一般線形モデル(lm {stats},aov {stats}):築年数 × 取引価格(総額:平米単価(円)):外れ値(±3σ)除去

```{r,warning=F,error=F,message=F,results='hold',echo=F}
summary(aov(glmResult))
```

```{r,warning=F,error=F,message=F,results='hold',echo=F}
summary(glmResult)
```

#### 築年数 × 取引価格(総額:平米単価(円)):線形回帰Slopeの95%信頼区間:外れ値(±3σ)除去

```{r,warning=F,error=F,message=F,results='hold',echo=F}
confint(lm(Torihikikakaku_sougaku_heibeitanka ~ Chikunensuu), 'Chikunensuu', level=0.95)
```

#### 一般化線形モデル:重回帰分析:外れ値(±3σ)除去

```{r,warning=F,error=F,message=F,results='hold',echo=F}
City <- 
  as.factor(dataSet[, city0])
Kouzou <- 
  as.factor(dataSet[, kouzou])
Youtochiiki <- 
  as.factor(dataSet[, youtochiiki])
Chikunensuu <- 
  dataSet[, chikunensuu]
glmResult <- 
  glm(Torihikikakaku_sougaku_heibeitanka ~ City + Kouzou + Youtochiiki + Chikunensuu)
summary(aov(glmResult))
```

```{r,warning=F,error=F,message=F,results='hold',echo=F}
summary(glmResult)
```

```{r,warning=F,error=F,message=F,results='asis',echo=F}
buf <- coef(summary(glmResult))[, c(1, 4)]
buf0 <-
  data.frame(
    Variable = rownames(buf),
    buf,
    check.names = F,
    stringsAsFactors = F,
    row.names = NULL
  )
buf0 <- 
  subset(buf0, buf0[, 3] <= 0.05)
buf0 <-
  data.frame(
    ID = seq(1, nrow(buf0)),
    buf0,
    check.names = F,
    stringsAsFactors = F
  )
fun_dataTable(obj = buf0, 
              dateFormat = 0, 
              title = 'Pr(>|t|) <= 0.05のみピックアップ',
              orderDirection = 'asc',
              leftcolumns = 2)
```

***
#### 基本統計量:市区町村別:取引価格(総額:平米単価(円))

```{r,warning=F,error=F,message=F,results='asis',echo=F}
boxData0 <- 
  dataSet0[,c(city0, torihikikakaku_sougaku_heibeitanka)]
for (iii in 1:length(unique(boxData0[, 1]))) {
  buf <- 
    subset(boxData0, boxData0[, 1] == unique(boxData0[, 1])[iii])
  colnames(buf)[2] <- unique(boxData0[, 1])[iii]
  if (iii == 1) {
    boxData <- buf[, 2, drop = F]
  } else{
    boxData <- qpcR:::cbind.na(boxData, buf[, 2, drop = F])
  }
}
```

```{r,warning=F,error=F,message=F,echo=F,results='asis'}
boxplot <-
  t(apply(boxData,2,function(x)summary(na.omit(x))))
boxplot <-
  data.frame(`市区町村名` = row.names(boxplot),
             boxplot,
             `データ数` = apply(boxData,2,function(x)length(na.omit(x))),
             check.names = F,stringsAsFactors = F,row.names = NULL)
fun_dataTable(boxplot,dateFormat = 0,needID = 1,orderDirection = 'asc',leftcolumns = 2)
```

***

```{r,warning=F,error=F,message=F,echo=F,results='asis'}
tableData <-
  data.frame(ID = seq(1, nrow(dataSet0)), 
             dataSet0[,c(city0,
                         city1,
                         torihikikakaku_sougaku,
                         menseki,
                         kenchikuYear,
                         kouzou,
                         youtochiiki,
                         chikunensuu,
                         torihikikakaku_sougaku_heibeitanka)],
             check.names = F, stringsAsFactors = F)
PopTable <- 
  googleVis::gvisTable(tableData,
                       options = list(width = 2000,
                                      height = 'automatic',
                                      page = 'enable',
                                      pageSize = 20))
plot(PopTable, tag = 'chart')
```

***
<script>MakeNegative();</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3077339-5', 'auto');
  ga('send', 'pageview');

</script>
