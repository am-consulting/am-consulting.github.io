```{r warning=F,error=F,message=F,echo=F,results='hide'}
windowsFonts(Meiryo = windowsFont("Meiryo"))
options(scipen = 100)
library(ggplot2)
library(ggpubr)
library(ggsci)
pngWidth <- 1000
pngHeight <- 600
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
userName <- Sys.info()['user']
fileName <- 'defaultPath.csv'
pathToFile <-
  paste0('C:/Users/',userName,'/Desktop/pathToCSV/')
setwd(pathToFile)
buf0 <-
  read.csv(fileName,header = F,skip = 0,stringsAsFactor = F,check.names = F,
           fileEncoding = 'UTF8')
pathOutput <- paste0('C:/Users/',userName,buf0[2,1],'charts/indicator/')
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
dataSource <-
  'Organisation for Economic Co-operation and Development'
script <-
  RCurl::getURL(
    url = "https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/importOECDStatisticData.r",
    ssl.verifypeer = F)
eval(parse(text = script))
```

```{r warning=F,error=F,message=F,echo=F,results='asis'}
yyyy <- 2017
mm <- 12
sdmxURL <- paste0("http://stats.oecd.org/restsdmx/sdmx.ashx/GetData/MEI_CLI/LOLITOTR_GYSA.AUS+AUT+BEL+CAN+CHL+CZE+DNK+EST+FIN+FRA+DEU+GRC+HUN+IRL+ISR+ITA+JPN+KOR+LVA+LUX+MEX+NLD+NZL+NOR+POL+PRT+SVK+SVN+ESP+SWE+CHE+TUR+GBR+USA+EA19+G4E+G-7+NAFTA+OECDE+OECD+ONM+A5M+NMEC+BRA+CHN+IND+IDN+RUS+ZAF.M/all?startTime=1947-02&endTime=",yyyy,"-",mm)
fun_OECDStatisticData(sdmxURL = sdmxURL)
oecd01 <- allOECDData
oecd01[,-1] <- apply(oecd01[,-1],2,function(x)round(x,1))
sdmxTitle01 <- '12-month rate of change of the trend restored CLI'

sdmxURL <- paste0("http://stats.oecd.org/restsdmx/sdmx.ashx/GetData/MEI_CLI/LOLITOAA.AUS+AUT+BEL+CAN+CHL+CZE+DNK+EST+FIN+FRA+DEU+GRC+HUN+IRL+ISR+ITA+JPN+KOR+LVA+LUX+MEX+NLD+NZL+NOR+POL+PRT+SVK+SVN+ESP+SWE+CHE+TUR+GBR+USA+EA19+G4E+G-7+NAFTA+OECDE+OECD+ONM+A5M+NMEC+BRA+CHN+IND+IDN+RUS+ZAF.M/all?startTime=1947-02&endTime=",yyyy,"-",mm)
fun_OECDStatisticData(sdmxURL = sdmxURL)
oecd02 <- allOECDData
oecd02[,-1] <- apply(oecd02[,-1],2,function(x)round(x,1))
sdmxTitle02 <- 'Amplitude adjusted'
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
fun_ggplot_line <- function(plotData,pngN,pngTitle,output = 0,needZero = 0,fontSize = 15){
  if(output!=0){
    setwd(pathOutput)
    pngFile <- paste0(pngTitle,pngN,".png")
    png(file = pngFile,width = pngWidth,height = pngHeight)
  }
  if(length(unique(lubridate::day(plotData$Date)))<=5){
    dateFormat <- '%Y-%m'
  }else{
    dateFormat <- '%Y-%m-%d'
  }
  dateRange <- paste0(format(range(plotData$Date),dateFormat),collapse = '~')
  latestData <- paste0(format(tail(plotData,1)[1,1],dateFormat),':',tail(plotData,1)[1,2])
  g <- ggplot(data = plotData,aes(x = Date,y = plotData[,2]))
  g <- g + geom_line(size = 0.5,col = "black")
  g <- g + geom_point(size = 1.0,col = "black")
  g <- g + geom_smooth(method = loess,lwd = 1,col = "red")
  g <- g + scale_x_date(labels = scales::date_format(dateFormat))
  g <- g + theme(plot.title = element_text(family = "Meiryo",hjust = 0.5,size = fontSize))
  g <- g + theme(axis.title.x = element_text(family = "Meiryo",size = fontSize))
  g <- g + theme(axis.title.y = element_text(family = "Meiryo",size = fontSize))
  g <- g + theme(axis.text.x = element_text(family = "Meiryo",size = fontSize, angle = 0))
  g <- g + theme(axis.text.y = element_text(family = "Meiryo",size = fontSize, angle = 90))
  g <- g + xlab('')
  g <- g + ylab('')
  g <- g + ggtitle(paste0(colnames(plotData)[2],'\n',dateRange,
                         '\nSource:',dataSource,
                         '\nUnit Root Test p-value:',round(tseries::adf.test(plotData[,2])$p.value,3),
                         '\nLatest:',latestData))
  if(needZero!=0){g <- g + geom_hline(yintercept = 0,col = 'blue')}
  print(g)
  if(output!=0){dev.off()}
}
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
fun_ggboxplotByYear <-
  function(obj,dateCol = 1,objCol = 2,ggtheme = theme_bw(),palette = "UChicago",
           add = "jitter",pngN,fontSize = 15,pngTitle,output = 0,yearN = 6){
    if(output!=0){
      setwd(pathOutput)
      pngFile <- paste0(pngTitle,pngN,".png")
      png(file = pngFile,width = pngWidth,height = pngHeight)
    }
    plotData <- obj[,c(dateCol,objCol)]
    plotData <-
      plotData[tail(unique(lubridate::year(plotData[,1])),yearN)[1]<=lubridate::year(plotData[,1]),]
    plotData$Year <-
      as.factor(lubridate::year(plotData[,1]))
    colnames(plotData)[2] <- 'Value'
    if(length(unique(lubridate::day(plotData$Date)))<=5){
      dateFormat <- '%Y-%m'
    }else{
      dateFormat <- '%Y-%m-%d'
    }
    dateRange <- paste0(format(range(plotData$Date),dateFormat),collapse = '~')
    p <-
      ggboxplot(plotData,x = "Year",y = 'Value',color = "Year",palette = palette,
                add = add,shape = "Year",ggtheme = ggtheme,repel = T)
    p <- p + ylab('') + theme(legend.position = "none")
    p <- p + ggtitle(paste0(colnames(obj)[objCol],'\n',dateRange,'\nSource:',dataSource))
    p <- p + theme(plot.title =   element_text(hjust=0.5,family='Meiryo',face='plain',size=fontSize))
    p <- p + theme(legend.text =  element_text(hjust=0.5,family='Meiryo',face='plain',size=fontSize))
    p <- p + theme(axis.title.x = element_text(hjust=0.5,family='Meiryo',face='plain',size=fontSize))
    p <- p + theme(axis.title.y = element_text(hjust=0.5,family='Meiryo',face='plain',size=fontSize))
    p <- p + theme(axis.text =    element_text(hjust=0.5,family='Meiryo',face='plain',size=fontSize))
    print(p)
    if(output!=0){dev.off()}
}
```

```{r warning=F,error=F,message=F,echo=F,results='asis'}
pngTitle01 <- 'AMCC-OECD-TS-'
pngTitle02 <- 'AMCC-OECD-BP-'
for(iii in 2:ncol(oecd01)){
  plotData <- na.omit(oecd01[,c(1,iii)])
  colnames(plotData)[2] <- paste0('Composite Leading Indicators:',
                                  colnames(plotData)[2],'\n',sdmxTitle01)
  fun_ggplot_line(plotData = plotData,pngN = iii-1,pngTitle = pngTitle01,output = 1)
  fun_ggboxplotByYear(obj = plotData,yearN = 8,pngN = iii-1,pngTitle = pngTitle02,output = 1)
}
txt <- ''
for(iii in 2:ncol(oecd01)){
  colTxt <- colnames(oecd01)[iii]
  txt <- 
    paste0(txt,'<b>',colTxt,'</b><br>\n')
  txt <- 
    paste0(txt,
           '<a href="http://indicator.am-consulting.co.jp/',pngTitle01,iii-1,'.png">\n')
  txt <- 
    paste0(txt,
           '<img border="2" src="http://indicator.am-consulting.co.jp/',pngTitle01,iii-1,
           '.png" width="20%" />\n')
  txt <-
    paste0(txt,'Timeseries\n</a>\n')
  txt <- 
    paste0(txt,
           '<a href="http://indicator.am-consulting.co.jp/',pngTitle02,iii-1,'.png">\n')
  txt <- 
    paste0(txt,
           '<img border="2" src="http://indicator.am-consulting.co.jp/',pngTitle02,iii-1,
           '.png" width="20%" />\n')
  txt <-
    paste0(txt,'Boxplot\n</a>\n<hr>\n')
}
htmlFile <-
  paste0('OECD-olive.html')
setwd(pathOutput)
write.table(x = txt,file = htmlFile,append = F,
            fileEncoding = 'utf8',col.names = F,row.names = F,quote = F)
```
