---
knit: (function(inputFile, encoding) {username<-Sys.info()['user'];fileName<-'defaultPath.csv';pathToFile <-paste0('C:/Users/', username,'/Desktop/pathToCSV/');setwd(pathToFile);buf0<-read.csv(fileName,header = F,skip = 0,stringsAsFactor = F,check.names = F,fileEncoding = 'utf-8');timeStamp<-format(Sys.time(),'%Y%m%d%H%M%S');rmarkdown::render(inputFile, encoding = encoding, output_file = paste0('C:/Users/',username,buf0[2,1],'charts/','am-consulting.co.jp-socialIndicatorsByPrefecture.html')) })
title : "社会生活統計指標"
author: "アセット･マネジメント･コンサルティング株式会社 http://am-consulting.co.jp"
output: 
  html_document:
    fig_height: 7
    fig_width: 10
    keep_md: no
    md_extensions: -ascii_identifiers 
---
<link href="http://knowledgevault.saecanet.com/components/rmarkdown-html.css" rel="stylesheet">
<script src="http://knowledgevault.saecanet.com/components/JavascriptCode.js"></script>
<style>.main-container {max-width : 1000px;}</style>

- アセット･マネジメント･コンサルティング株式会社 http://am-consulting.co.jp
- SaECaNet http://saecanet.com/
- Olive http://olive.saecanet.com/
- twitter https://twitter.com/AMC2_Japan
- 本ページへのリンクを共有:<a href="https://twitter.com/share" class="twitter-share-button" data-via="AMC2_Japan" data-size="large">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

```{r set-options, echo=F, cache=F}
options(width = 1000)
```

```{r warning = F, error = F, message = F, echo = F}
library(RCurl)
fileName <- 'functionList.csv'
functionList <-
  read.csv(
    file = paste0('https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/csv/',
                  fileName),
    header = F,
    as.is = T)
for(iii in 1:nrow(functionList)){
  script <- 
    getURL(paste0("https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/", 
                  functionList[iii,1]),
           ssl.verifypeer = F)
  eval(parse(text = script))
}
```

```{r warning=F, error=F, message=F, echo=F, results='hold'}
library(rvest)
url <- 
  'http://www.e-stat.go.jp/SG1/estat/GL08020103.do?_toGL08020103_&tclassID=000001084000&cycleCode=0&requestSender=estat'
htmlMarkup <- 
  read_html(url, encoding = "utf8")
linkLists <- 
  htmlMarkup %>% html_nodes(xpath = "//a") %>% html_attr("href")
linkLists <- 
  linkLists[grep('xlsdownload', linkLists, ignore.case = T)]
```

```{r warning=F, error=F, message=F, echo=F, results='hold'}
urlToFile <-
  'https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/csv/prefectureID.csv'
prefectureID <-
  read.csv(urlToFile,
           header = T,
           skip = 0,
           stringsAsFactor = F,
           na.strings = c("", "***"),
           check.names = F,
           fileEncoding = "utf8")
```

```{r warning=F, error=F, message=F, echo=F, results='hold'}
username <- 
  Sys.info()['user']
pathOutput <- 
  paste0("C:/Users/", username, "/Desktop/socialIndicatorsByPrefecture/")
setwd(pathOutput)
for(fff in 1:length(linkLists)){
  download.file(url = paste0('http://www.e-stat.go.jp/SG1/estat/', linkLists[fff]), 
                destfile = paste0(letters[fff],'.xls'), 
                mode = "wb")
}
```

```{r warning=F, error=F, message=F, echo=F, results='hold'}
dataTitle <- '社会生活統計指標-都道府県の指標:2017年:基礎データ'
dataSource <- '総務省'
windowsFonts(Meiryo = windowsFont("Meiryo"))
options(scipen = 999)
```

***

- `r paste0("タイトル : ", dataTitle)`
- `r paste0("データ出所 : ", dataSource)`
- http://www.stat.go.jp/data/guide/1.htm
- http://www.stat.go.jp/data/shihyou/index.htm
- http://www.stat.go.jp/data/shihyou/naiyou.htm
- `r url`

***

```{r warning=F, error=F, message=F, echo=F, results='hide'}
library(XLConnect);library(Nippon)
```

```{r warning=F, error=F, message=F, echo=F, results='hide'}
setwd(pathOutput)
for(iii in 1:length(linkLists)){
  fileName <- 
    paste0(letters[iii],'.xls')
  buf0 <- 
    readWorksheetFromFile(paste0(pathOutput, fileName), sheet = 1, check.names = F, header = F)
  Prefecture <- gsub('\\s','',sapply(buf0[,2],zen2han))
  tmp <- NA
  for(ccc in 1:ncol(buf0)){
    if(!is.na(buf0[5,ccc])){
      tmp <- paste0(buf0[5,ccc], buf0[6,ccc])
    }
    colnames(buf0)[ccc] <- 
      zen2han(gsub('\\s','',paste0(tmp, buf0[11,ccc], '-', buf0[12,ccc])))
  }
  tmp <- as.numeric(buf0[12,])
  tmp[is.na(tmp)] <- -999
  objCloumn <- vector()
  cnt <- 0
  for(ccc in 1:length(tmp)){
    if(ccc == length(tmp)){
      if(tmp[ccc] != -999){
        cnt <- cnt + 1
        objCloumn[cnt] <- ccc
        }else{
          break
        }
    }
    if(tmp[ccc + 1] < tmp[ccc]){
      cnt <- cnt + 1
      objCloumn[cnt] <- ccc
    }
  }
  buf1 <-
    buf0[,objCloumn]
  buf2 <-
    data.frame(Prefecture,buf1,check.names = F,stringsAsFactors = F,row.names = NULL)
  buf3 <-
    buf2[grep('全国', buf2[,1]):nrow(buf2),]
  buf4 <-
    buf3[!is.na(buf3[,3]),]
  buf4[,-1] <-
    apply(buf4[,-1],2,function(x)as.numeric(gsub(',','',x)))
  colnames(buf4) <- gsub('na','',colnames(buf4),ignore.case = T)
  colnames(buf4) <- gsub(':[0-9a-z]+','',colnames(buf4),ignore.case = T)
  colnames(buf4)[1] <- '都道府県'
  assign(paste0(letters[iii],'_kiso'),buf4,envir = .GlobalEnv)
  if(iii == 1){
    allData0 <- buf4
  }else{
    allData0 <- merge(allData0, buf4, all = T, by = '都道府県')
  }
}
```

```{r warning=F, error=F, message=F, echo=F, results='hide'}
allData <- merge(allData0,prefectureID,by = '都道府県')
allData <- allData[,c(ncol(allData),1:(ncol(allData)-1))]
```

```{r warning=F, error=F, message=F, echo=F}
funGroup <- function(dS){
dS$Group01 <- 
  ifelse(as.numeric(dS$ID) <= 7, '北海道･東北地方',
  ifelse(as.numeric(dS$ID) <= 14,'関東地方',
  ifelse(as.numeric(dS$ID) <= 23,'中部地方',
  ifelse(as.numeric(dS$ID) <= 30,'関西地方',
  ifelse(as.numeric(dS$ID) <= 35,'中国地方',
  ifelse(as.numeric(dS$ID) <= 39,'四国地方','九州･沖縄地方'))))))
dS$Group02 <- 
  ifelse(as.numeric(dS$ID) <= 14,'東日本','西日本')
dS$Group03 <- 
  ifelse(as.numeric(dS$ID) <= 14,'東日本',
  ifelse(as.numeric(dS$ID) <= 24,'中日本','西日本'))
dS$Group04 <- 
  ifelse(as.numeric(dS$ID) <= 1, '北海道',
  ifelse(as.numeric(dS$ID) <= 7, '東北地方',
  ifelse(16 <= as.numeric(dS$ID) & as.numeric(dS$ID) <= 18, '北陸地方',
  ifelse(8  <= as.numeric(dS$ID) & as.numeric(dS$ID) <= 15, '関東甲信越地方',
  ifelse(19 <= as.numeric(dS$ID) & as.numeric(dS$ID) <= 20, '関東甲信越地方',
  ifelse(21 <= as.numeric(dS$ID) & as.numeric(dS$ID) <= 24, '東海地方',
  ifelse(as.numeric(dS$ID) <= 30,'近畿地方',
  ifelse(as.numeric(dS$ID) <= 35,'中国地方',
  ifelse(as.numeric(dS$ID) <= 39,'四国地方','九州･沖縄地方')))))))))
colnames(dS)
return(dS)
}
```

```{r warning=F, error=F, message=F, echo=F, results='asis'}
dataset <- funGroup(dS = allData)
dataset0 <- dataset
dataset0[is.na(dataset0[,1]),1] <- 0
dataset0[is.na(dataset0)] <- -9999
dataset0[,2] <- paste0(formatC(dataset0[,1], width=2, flag="0"),dataset0[,2])
dataset0 <- dataset0[,-1]
```

```{r warning=F, error=F, message=F, echo=F, results='asis'}
allData[,-c(1,2)] <-
  apply(allData[,-c(1,2)],2,function(x)format(x, big.mark = ",", scientific = F))
fun_dataTable(obj = allData,orderDirection = 'asc',dateFormat = 0,leftcolumns = 2)
```

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3077339-5', 'auto');
  ga('send', 'pageview');

</script>
