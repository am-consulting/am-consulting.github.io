---
knit: (function(inputFile, encoding) {username<-Sys.info()['user'];fileName<-'defaultPath.csv';pathToFile <-paste0('C:/Users/', username,'/Desktop/pathToCSV/');setwd(pathToFile);buf0<-read.csv(fileName,header = F,skip = 0,stringsAsFactor = F,check.names = F,fileEncoding = 'utf-8');htmlName<-'OTCRetailFXMarginTrading';rmarkdown::render(inputFile, encoding = encoding, output_file = paste0('C:/Users/',username,buf0[4,1],'am-consulting.co.jp-',htmlName,'.html')) })

title : 'OTC Retail FX Margin Trading'
author: "アセット･マネジメント･コンサルティング株式会社 http://am-consulting.co.jp"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: 
  html_document:
    fig_height: 5
    fig_width: 9
    keep_md: no
    md_extensions: -ascii_identifiers 
    includes:
       in_header: insertHeader.html
    self_contained: false
---

```{r setup, include=FALSE}
tag <-
  read.csv(file = 'https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/components/insertHeader.csv',header = F,fileEncoding = 'UTF8')
tagTxt <- ''
for(rrr in 1:nrow(tag)){
  tagTxt <- paste0(tagTxt,tag[rrr,1],'\n')
}
insertFile <- file("insertHeader.html")
writeLines(text = tagTxt,con = insertFile)
close(insertFile)
```

- アセット･マネジメント･コンサルティング株式会社 http://am-consulting.co.jp
- SaECaNet http://saecanet.com/
- Olive http://olive.saecanet.com/
- twitter https://twitter.com/AMC2_Japan
- 本ページへのリンクを共有:<a href="https://twitter.com/share" class="twitter-share-button" data-via="AMC2_Japan" data-size="large">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

```{r set-options, echo=F, cache=F}
options(width = 900)
```

```{r warning = F, error = F, message = F, echo = F}
library(RCurl)
fileName <- 'functionList.csv'
functionList <-
  read.csv(
    file = paste0('https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/csv/',
                  fileName),
    header = F,
    as.is = T)
for(iii in 1:nrow(functionList)){
  script <- 
    getURL(paste0("https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/", 
                  functionList[iii,1]),
           ssl.verifypeer = F)
  eval(parse(text = script))
}
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
script <- 
  getURL(paste0('https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/', 
                'R-MonthlyTradingVolumeOTC.r'),
         ssl.verifypeer = F)
eval(parse(text = script))
script <- 
  getURL(paste0('https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/', 
                'R-OTCforMajorCurrencies.r'),
         ssl.verifypeer = F)
eval(parse(text = script))
fun_MonthlyTradingVolumeOTCforMajorCurrencies()
sheet.no <- c('USDJPY','EURJPY','GBPJPY','AUDJPY','CHFJPY','CADJPY','NZDJPY','ZARJPY','EURUSD','GBPUSD')
for(iii in seq(length(sheet.no))){
  fun_MonthlyTradingVolumeOTC(sheetNo = sheet.no[iii])
}  
```

```{r warning=F,error=F,message=F,echo=F,results='hold'}
dateFormat <- '%Y年%m月'
dataTitle <- 
  paste0('店頭外国為替証拠金取引月次出来高:',format(tail(OTCforMajorCurrencies[,1],1),dateFormat))
dataSource <- '一般社団法人金融先物取引業協会'
windowsFonts(Meiryo = windowsFont("Meiryo"))
options(scipen = 999)
library(ggplot2)
library(Rmisc)
caption.subtitle.size <- 11
plot.text.size <- 11
base.size <- 10
```

***

- `r paste0("タイトル : ", dataTitle)`
- `r paste0("データ出所 : ", dataSource)`
- Source http://www.ffaj.or.jp/index.html

***

#### 店頭外国為替証拠金取引の状況時系列推移

```{r warning=F, error=F, message=F, echo=F, results='asis'}
for(iii in seq(length(sheet.no))){
  obj0 <- get(sheet.no[iii])
  obj <- na.omit(obj0[,c(1,2)])
  obj[,2] <- apply(obj[,2,drop=F],2,function(x)x*10^-6)
  colnames(obj)[2] <- paste0(colnames(obj)[2],':兆円')
  cat(paste0('##### ',colnames(obj)[2],'\n\n'))
  cat('- 取引金額(日本円換算出来高、兆円)\n\n')
  date.range <- paste0(format(range(obj[,1]),dateFormat),collapse = '~')
  obj.ma <- fun_MovingAverage(obj = obj)
  cols <- c(assign(colnames(obj.ma)[2],'blue'),assign(colnames(obj.ma)[3],'red'))
  g <- ggplot(data = obj.ma,aes(x = obj.ma[,1]))
  g <- g + theme_grey(base_size = base.size,base_family = 'Meiryo')
  g <- g + geom_line(aes(y = obj.ma[,2],col = colnames(obj.ma)[2]))
  g <- g + geom_point(aes(y = obj.ma[,2],col = colnames(obj.ma)[2]))
  g <- g + geom_line(aes(y = obj.ma[,3],col = colnames(obj.ma)[3]))
  g <- g + scale_colour_manual(name = '',values = c(get(colnames(obj.ma)[2]),get(colnames(obj.ma)[3])))
  g <- g + ggtitle(label = paste0(colnames(obj.ma)[2],'\n',date.range,'\nSource:',dataSource))
  g <- g + scale_y_continuous(name = '',breaks = scales::pretty_breaks(10),sec.axis = dup_axis())
  g <- g + theme(plot.title = element_text(hjust = 0.5))  
  g <- g + theme(axis.text.x = element_text(size = plot.text.size,angle = 0))
  g <- g + theme(axis.text.y = element_text(size = plot.text.size,angle = 0))
  g <- g + theme(plot.subtitle = element_text(size = caption.subtitle.size,angle = 0))
  g <- g + theme(plot.caption = element_text(size = caption.subtitle.size,angle = 0))
  g <- g + theme(legend.text = element_text(angle = 0,size = plot.text.size))  
  g <- g + theme(legend.position = "top")
  g <- g + xlab('')
  print(g)
  cat('\n<hr>\n')
  obj.yoy <- fun_makeDiffRatioTable(obj = obj,lag = 12)
  obj.yoy$col <- ifelse(obj.yoy[,2]<0,'red','blue')
  date.range <- paste0(format(range(obj.yoy[,1]),dateFormat),collapse = '~')
  g <- ggplot(data = obj.yoy,aes(x = obj.yoy[,1],y = obj.yoy[,2]))
  g <- g + theme_grey(base_size = base.size,base_family = 'Meiryo')
  g <- g + geom_bar(stat = 'identity',aes(fill = obj.yoy$col))
  g <- g + scale_fill_manual(values = c(blue = '#4169e1',red = '#dc143c'))
  g <- g + theme(legend.position = "none")
  g <- g + xlab('')
  g <- g + ggtitle(label = paste0(colnames(obj.yoy)[2],'\n前年同月比(%)\n',date.range,'\nSource:',dataSource))
  g <- g + scale_y_continuous(name = '',breaks = scales::pretty_breaks(10),sec.axis = dup_axis())
  g <- g + theme(plot.title = element_text(hjust = 0.5))  
  g <- g + theme(axis.text.x = element_text(size = plot.text.size,angle = 0))
  g <- g + theme(axis.text.y = element_text(size = plot.text.size,angle = 0))
  g <- g + theme(plot.subtitle = element_text(size = caption.subtitle.size,angle = 0))
  g <- g + theme(plot.caption = element_text(size = caption.subtitle.size,angle = 0))
  print(g)
  cat('\n<hr>\n')
  cat('- 月末ポジション(億円)\n\n')
  obj <- na.omit(obj0[,c(1,3,4)])
  obj[,-1] <- apply(obj[,-1,drop=F],2,function(x)x*10^-2)
  colnames(obj)[-1] <- paste0(colnames(obj)[-1],':億円')
  date.range <- paste0(format(range(obj[,1]),dateFormat),collapse = '~')
  cols <- c(assign(colnames(obj)[2],'blue'),assign(colnames(obj)[3],'red'))
  g <- ggplot(data = obj,aes(x = obj[,1]))
  g <- g + theme_grey(base_size = base.size,base_family = 'Meiryo')
  g <- g + geom_line(aes(y = obj[,2],col = colnames(obj)[2]))
  g <- g + geom_point(aes(y = obj[,2],col = colnames(obj)[2]))
  g <- g + geom_line(aes(y = obj[,3],col = colnames(obj)[3]))
  g <- g + geom_point(aes(y = obj[,3],col = colnames(obj)[3]))
  g <- g + scale_colour_manual(name = '',values = c(get(colnames(obj)[2]),get(colnames(obj)[3])))
  g <- g + ggtitle(label = paste0('月末ポジション\n',date.range,'\nSource:',dataSource))
  g <- g + scale_y_continuous(name = '',breaks = scales::pretty_breaks(10),sec.axis = dup_axis())
  g <- g + theme(plot.title = element_text(hjust = 0.5))
  g <- g + theme(axis.text.x = element_text(size = plot.text.size,angle = 0))
  g <- g + theme(axis.text.y = element_text(size = plot.text.size,angle = 0))
  g <- g + theme(plot.subtitle = element_text(size = caption.subtitle.size,angle = 0))
  g <- g + theme(plot.caption = element_text(size = caption.subtitle.size,angle = 0))
  g <- g + theme(legend.text = element_text(angle = 0,size = plot.text.size))  
  g <- g + theme(legend.position = "top")
  g <- g + xlab('')
  print(g)
  cat('\n<hr>\n')
}
```

```{r warning=F, error=F, message=F, echo=F, results='hide'}
username <- Sys.info()['user']
pathToFile <- paste0('C:/Users/', username,'/Desktop/pathToCSV/')
setwd(pathToFile)
fileName <- 'defaultPath.csv'
buf <-
  read.csv(file = fileName,header = F,skip = 0,stringsAsFactor = F,check.names = F,
           fileEncoding = 'utf-8',quote = "\"")
pathOutputTOchart <- paste0("C:/Users/", username, buf[4,1])
#---------------------------------------------------
base.size <- 11
plot.text.size <- 11
caption.subtitle.size <- 11
obj.col <- grep('買越額',colnames(OTCforMajorCurrencies))
obj <- OTCforMajorCurrencies[,c(1,obj.col)]
plots <- list()
plots.txt <- vector()
for(ccc in 2:ncol(obj)){
  plot.data <- na.omit(obj[,c(1,ccc)])
  plot.data[,2] <- apply(plot.data[,2,drop=F],2,function(x)x*10^-6)
  colnames(plot.data)[2] <- paste0(colnames(plot.data)[2],':兆円')
  plot.title <- colnames(plot.data)[2]
  colnames(plot.data) <- c('x','y')
  date.range <- paste0(format(range(plot.data$x),dateFormat),collapse = '~')
  g <- ggplot(data = plot.data,aes(x = x,y = y)) + geom_line() + xlab('') + ylab('')
  g <- g + theme_grey(base_size = base.size,base_family = 'Meiryo')
  g <- g + ggtitle(label = paste0(gsub('([^:]+).+','\\1',plot.title),'\n',date.range))
  g <- g + geom_smooth() + geom_hline(yintercept=0,linetype = 1,col = 'red')
  g <- g + theme(plot.title = element_text(hjust = 0.5))
  g <- g + theme(axis.text.x = element_text(size = plot.text.size,angle = 0))
  g <- g + theme(axis.text.y = element_text(size = plot.text.size,angle = 0))
  g <- g + theme(plot.subtitle = element_text(size = caption.subtitle.size,angle = 0))
  g <- g + theme(plot.caption = element_text(size = caption.subtitle.size,angle = 0))
  plots[[ccc-1]] <- g
}
figure <- 
  ggarrange(plots[[1]],plots[[2]],plots[[3]],plots[[4]],plots[[5]],plots[[6]],plots[[7]],plots[[8]],plots[[9]],
            ncol = 3, nrow = 3)
multi.plot <- annotate_figure(figure,
                              top = text_grob(paste0('月末建玉状況:買越額(買建-売建,単位:兆円)\nSource:',dataSource),
                                              size = 14,family = 'Meiryo'))
setwd(pathOutputTOchart)
pngFile <-
  paste0(htmlName, "1.png")
png(file = pngFile, width = 1000, height = 600)
print(multi.plot)
dev.off()
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
latest.data <- fun_transposeDataFrame(obj = obj,dateFormat = dateFormat)
latest.data$Item <- gsub('([^:]+).+','\\1',latest.data$Item)
colnames(latest.data)[1] <- '通貨'
latest.data[,-1] <- apply(latest.data[,-1,drop=F],2,function(x)round(x*10^-6,4))
fun_outputMD(tags = '一般社団法人金融先物取引業協会,店頭外国為替証拠金取引月次出来高',
             objDF = latest.data,
             htmlName = htmlName,
             image1 = 1,
             title = dataTitle,
             tableTitle = paste0('データ出所:', dataSource),
             tableName = '直近5ヶ月分の月末建玉状況:買越額(買建-売建,単位:兆円)',
             buf.row = 4)
fun_updateURLcsv.olive()
```

<script>MakeNegative()</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3077339-5', 'auto');
  ga('send', 'pageview');

</script>
