---
knit: (function(inputFile, encoding) {username<-Sys.info()['user'];fileName<-'defaultPath.csv';pathToFile <-paste0('C:/Users/', username,'/Desktop/pathToCSV/');setwd(pathToFile);buf0<-read.csv(fileName,header = F,skip = 0,stringsAsFactor = F,check.names = F,fileEncoding = 'utf-8');timeStamp<-format(Sys.time(),'%Y%m%d%H%M%S');htmlName<-'internationalTransactionsInSecurities';rmarkdown::render(inputFile, encoding = encoding, output_file = paste0('C:/Users/',username,buf0[2,1],'charts/','am-consulting.co.jp-',htmlName,'.html')) })

title : "International Transactions In Securities"
author: "アセット･マネジメント･コンサルティング株式会社 http://am-consulting.co.jp"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: 
  html_document:
    fig_height: 8
    fig_width: 9
    keep_md: no
    md_extensions: -ascii_identifiers 
    includes:
       in_header: insertHeader.html
    self_contained: false
---

```{r setup, include=FALSE}
tag <-
  read.csv(file = 'https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/components/insertHeader.csv',header = F,fileEncoding = 'UTF8')
tagTxt <- ''
for(rrr in 1:nrow(tag)){
  tagTxt <- paste0(tagTxt,tag[rrr,1],'\n')
}
insertFile <- file("insertHeader.html")
writeLines(text = tagTxt,con = insertFile)
close(insertFile)
```

- アセット･マネジメント･コンサルティング株式会社 http://am-consulting.co.jp
- SaECaNet http://saecanet.com/
- Olive http://olive.saecanet.com/
- twitter https://twitter.com/AMC2_Japan
- 本ページへのリンクを共有:<a href="https://twitter.com/share" class="twitter-share-button" data-via="AMC2_Japan" data-size="large">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

```{r warning = F, error = F, message = F, echo = F}
library(RCurl)
fileName <- 'functionList.csv'
functionList <-
  read.csv(
    file = paste0('https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/csv/',
                  fileName),
    header = F,
    as.is = T)
for(iii in 1:nrow(functionList)){
  script <- 
    getURL(paste0("https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/", 
                  functionList[iii,1]),
           ssl.verifypeer = F)
  eval(parse(text = script))
}
```

```{r set-options, echo=F, cache=F}
options(width = 900)
```

```{r,warning=F,error=F,message=F,echo=F,results='hold'}
script <-
  getURL(
    "https://raw.githubusercontent.com/am-consulting/Rscript/master/internationalTransactionsInSecurities.r",
    ssl.verifypeer = FALSE
  )
eval(parse(text = script))
```

```{r,warning=F,error=F,message=F,results='hold',echo=F}
origData$year <- as.numeric(substring(origData[,2],1,4))
origData$month <- as.numeric(gsub('．','',(substring(origData[,2],6,7))))
origData$H <- ifelse(origData$month<=6,1,2)
origData$Q <- ifelse(origData$month<=3,1,ifelse(origData$month<=6,2,ifelse(origData$month<=9,3,4)))
origData[,2] <- gsub('．','.',origData[,2])
```

```{r,warning=F,error=F,message=F,results='hold',echo=F}
objColumn <- grep('持分:ネット',colnames(origData))
latestResult <- 
  paste0(tail(origData[,2],1),
         '(億円):',
         paste0(colnames(origData)[objColumn],':',tail(origData[,objColumn],1),collapse = ','))
dataTitle <- paste0(titleJ,':', latestResult)
dataSource <- '財務省'
windowsFonts(Meiryo = windowsFont("Meiryo"))
options(scipen = 999)
dateFormat <- '%Y-%m-%d'
```

***

- `r paste0("タイトル : ", dataTitle)`
- `r paste0("データ出所 : ", dataSource)`
- Source : http://www.mof.go.jp/international_policy/reference/itn_transactions_in_securities/

***

1. 対外、対内ともプラス値は取得超を、マイナス値は処分超を意味します。
1. 対外証券投資
	1. 居住者による取得または処分
	1. 取得超は資産増加つまり資金流出、処分超は資産減少つまり資金流入を意味します。
1. 対内証券投資
	1. 非居住者による取得または処分
	1. 取得超は負債増加つまり資金流入、処分超は負債減少つまり資金流出を意味します。
1. 単位は全て億円。	

***

```{r warning=F,error=F,message=F,echo=F,results='asis'}
date <-
  as.Date(gsub('\\.','-',substring(origData[,2],1,unlist(regexec('～', origData[,2]))-1)))
specificDF <-
  data.frame(Date = date, origData[,c(8,16,19)], stringsAsFactors = F, check.names = F)
specificDFall <-
  data.frame(Date = date, origData, stringsAsFactors = F, check.names = F)
```

```{r warning=F,error=F,message=F,echo=F,results='asis',fig.height=4}
obj <- specificDF[,c(1,2)]
n <- 1
fun_generateKnit(objDF = obj,plotNum = n,barPlot = 1,dygraphTitle = colnames(obj)[2],quantiles = 2)
eval(parse(text = paste0('dygraphPlot', n, ' %>% ', primeMinisterOfJapan_dygraph)))
cat('<hr>')
obj <- specificDF[,c(1,3)]
n <- 2
fun_generateKnit(objDF = obj,plotNum = n,barPlot = 1,dygraphTitle = colnames(obj)[2],quantiles = 2)
eval(parse(text = paste0('dygraphPlot', n, ' %>% ', primeMinisterOfJapan_dygraph)))
cat('<hr>')
obj <- specificDF[,c(1,4)]
n <- 3
fun_generateKnit(objDF = obj,plotNum = n,barPlot = 1,dygraphTitle = colnames(obj)[2],quantiles = 2)
eval(parse(text = paste0('dygraphPlot', n, ' %>% ', primeMinisterOfJapan_dygraph)))
```

- 基本統計量

```{r warning=F,error=F,message=F,echo=F,results='hold'}
cat('期間:',paste0(range(specificDF[,1]),collapse = '~'))
cat('\n\n')
apply(specificDF[,2,drop=F],2,summary)
cat('\n\n')
apply(specificDF[,3,drop=F],2,summary)
cat('\n\n')
apply(specificDF[,4,drop=F],2,summary)
```

***
#### 第2次安倍内閣発足(2012年12月26日)以降のネット合計(兆円)

```{r warning=F,error=F,message=F,echo=F,results='asis'}
bufDF <- 
  subset(specificDF,as.Date('2012-12-26') <= specificDF[,1])
bufDF <-
  cbind(apply(bufDF[,-1],2,sum))
bufDF <-
  data.frame(Item = row.names(bufDF),bufDF,stringsAsFactors = F,row.names = NULL)
bufDF[,-1] <- apply(bufDF[,-1,drop=F],2,function(x)x*10^-4)
colnames(bufDF)[2] <- '第2次安倍内閣発足以降のネット合計(兆円)'
fun_markdownTable(obj = bufDF)
```

***

```{r warning=F,error=F,message=F,echo=F,results='asis'}
fun_dataTable(obj = tail(origData[,-grep('year|month|h|q',colnames(origData),ignore.case = T)],50),
              leftcolumns = 2,
              dateFormat = 0)
```

***
#### 対内証券投資の期間(年･半期･四半期)総計

```{r,warning=F,error=F,message=F,results='asis',echo=F}
tableStat <- data.frame()
cnt <- 1
objY <- unique(origData$year)
for(iii in objY){
  tmp <- subset(origData,origData$year==iii) 
  tableStat[cnt,1] <- iii  
  tableStat[cnt,2] <- sum(tmp$`対内-株式･投資ファンド持分-ネット`)
  tableStat[cnt,3] <- sum(tmp$`対内-中長期債-ネット`)
  cnt <- cnt+1
}

for(iii in objY){
  tmp <- subset(origData,origData$year==iii)
  for(sss in 1:2){
    tmp0 <- subset(tmp, tmp$H==sss)
    tableStat[cnt,1] <- paste0(iii,'-H',sss)
    tableStat[cnt,2] <- sum(tmp0$`対内-株式･投資ファンド持分-ネット`)
    tableStat[cnt,3] <- sum(tmp0$`対内-中長期債-ネット`)
    cnt <- cnt+1
  }
}  
  
for(iii in objY){
  tmp <- subset(origData,origData$year==iii)
  for(sss in 1:4){
    tmp0 <- subset(tmp,tmp$Q==sss)
    tableStat[cnt,1] <- paste0(iii,'-Q',sss)
    tableStat[cnt,2] <- sum(tmp0$`対内-株式･投資ファンド持分-ネット`)
    tableStat[cnt,3] <- sum(tmp0$`対内-中長期債-ネット`)
    cnt <- cnt+1
  }
}

tableStat <- data.frame(seq(1,nrow(tableStat)), tableStat, check.names = F, stringsAsFactors = F)
# tableStat[,3:4] <- format(tableStat[,3:4], big.mark=",", scientific=F)
colnames(tableStat) <- c('ID','年･半期･四半期','対内-株式･投資ファンド持分-ネット','対内-中長期債-ネット')

fun_dataTable(obj = tableStat,
              leftcolumns = 2,
              dateFormat = 0,
              title = paste0('対内証券投資(単位:億円) - ', 
                             head(origData[,2],1), ' ~ ', tail(origData[,2],1)))
```

***
#### 株式･投資ファンド持分及び合計の基本統計量

```{r,warning=F,error=F,message=F,results='hold',echo=F}
statData <- origData[,c(1,2,5,8,13,16,19,24)]
cat('期間:',paste0(range(statData[,2]),collapse = ' - '))
cat('\n\n')
apply(statData[,3,drop=F],2,summary)
cat('\n\n')
apply(statData[,5,drop=F],2,summary)
cat('\n\n')
apply(statData[,6,drop=F],2,summary)
cat('\n\n')
apply(statData[,8,drop=F],2,summary)
```

***
#### 直近`r tailN <- 3;tailN`週分
- 原数値(億円)

```{r,warning=F,error=F,message=F,results='asis',echo=F}
buf <- tail(origData, tailN)
buf <- buf[,-grep('year|month|h|q', colnames(buf), ignore.case = T)]
buf <- t(buf)
buf <- data.frame(rownames(buf), buf)
colnames(buf) <- unlist(buf[2, ])
buf <- buf[-(1:2), ]
colnames(buf)[1] <- '対象'
buf[,-1] <- apply(buf[,-1],2,as.numeric)
fun_markdownTable(obj = buf)
```

***
- 前週差(億円)

```{r warning=F,error=F,message=F,echo=F,results='asis'}
WoW <- 
  data.frame(tail(origData[,2],-1),diff(as.matrix(origData[,-c(1:2)]),lag = 1),check.names = F,stringsAsFactors = F)
tDF <- t(tail(WoW[,1:23],tailN))
tDF <- data.frame(row.names(tDF),tDF,check.names = F,stringsAsFactors = F,row.names = NULL)
colnames(tDF) <- tDF[1,]
tDF <- tDF[-1,]
colnames(tDF)[1] <- '対象'
tDF[,-1] <- apply(tDF[,-1],2,as.numeric)
fun_markdownTable(tDF)
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
bufDF <- 
  subset(specificDF,as.Date('2012-12-26') <= specificDF[,1])
bufDF <-
  cbind(apply(bufDF[,-1],2,sum))
bufDF <-
  data.frame(Item = row.names(bufDF),bufDF,stringsAsFactors = F,row.names = NULL)
bufDF[,-1] <- apply(bufDF[,-1,drop=F],2,function(x)x*10^-4)
colnames(bufDF)[2] <- '第2次安倍内閣発足以降のネット合計(兆円)'
fun_markdownTable(obj = bufDF)
###
tailN <- 3
buf <- tail(origData, tailN)
buf <- buf[,-grep('year|month|h|q', colnames(buf), ignore.case = T)]
buf <- t(buf)
buf <- data.frame(rownames(buf), buf)
colnames(buf) <- unlist(buf[2, ])
buf <- buf[-(1:2), ]
colnames(buf)[1] <- '対象'
buf[,-1] <- apply(buf[,-1],2,as.numeric)
fun_markdownTable(obj = buf)
###
# fun_updateURLcsv()
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
fun_preparePlot()
pngFile <-
  paste0(htmlName, "1.png")
png(file = pngFile, width = 1000, height = 600)
obj <- specificDF[,c(1,3)]
fun_plotTimeSeries(obj = obj,chartType = 0,typeL = 'h',
                   dateFormat = dateFormat,mar = c(4,4,5,2),dataSource = paste0(dataSource,'.   単位:億円'),
                   needLefLab = 0,fitLcolor = 0)
fun_addTxtToChart(obj = obj,funType = 'min')
dev.off()
```

```{r warning=F,error=F,message=F,echo=F,results='hide'}
pmABE <- 
  subset(specificDFall,as.Date('2012-12-26') <= specificDFall[,1])
pmABE <-
  pmABE[,c(1,grep('ネット',colnames(pmABE)))]
pmABE <-
  cbind(apply(pmABE[,-1],2,sum))
pmABE <-
  data.frame(Item = row.names(pmABE),pmABE,stringsAsFactors = F,row.names = NULL)
pmABE[,-1] <- 
  apply(pmABE[,-1,drop=F],2,function(x)x*10^-4)
colnames(pmABE)[2] <- 
  '第2次安倍内閣発足以降のネット合計(兆円)'
fun_outputMD(tags = '財務省,証券売買契約',
             objDF = pmABE,
             summaryDF = specificDF[,c(1,3)],
             dateFormat = '%Y-%m-%d',
             dateCol = 1,
             objCol = 2,
             htmlName = htmlName,
             image1 = 1,
             image2 = 0,
             title = dataTitle,
             tableTitle = paste0('第2次安倍内閣発足以降のネット合計(兆円)'),
             tableName = '第2次安倍内閣発足以降のネット合計(兆円)')
fun_updateURLcsv()
```

***
<script>MakeNegative()</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3077339-5', 'auto');
  ga('send', 'pageview');

</script>
